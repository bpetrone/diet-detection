---
title: "Ordinations (all proteins)"
output: html_notebook
---

# R setup

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r libraries, echo=FALSE}
library(here) 
library(phyloseq) 
library(tidyverse) 
```

```{r}
# Define color palettes
subj.colors <- 
     palette.colors(n = 5, 
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Plotting themes
theme_set(theme_bw() +
               theme(
                    axis.text = element_text(size = 12),
                    axis.title.x = element_text(size = 14,
                                                face = 'bold'),
                    axis.title.y = element_text(size = 14,
                                                face = 'bold'),
                    legend.title = element_text(size = 12,
                                                face = 'bold'),
                    strip.text = element_text(size = 12,
                                              face = 'bold')
               )
)
```

# Read in data

## Metaproteomic phyloseq

```{r}
ps.protein <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'ps_mp (all proteins).rds') %>% # 1UP
     readRDS() 

ps.protein
```

# Pre-process

### Add lag day

```{r echo = FALSE}
# Pull sample data for stool samples
samdf.protein <- 
     sample_data(ps.protein) %>% 
     as('data.frame') %>% 
     rownames_to_column(var = 'row')

# Label each stool sample with its two preceding days
for (delta in 1:2){
     varname <- paste0('delta', delta)
     samdf.protein <- mutate(samdf.protein, 
                             !!varname := paste(subj, date - delta, 
                                                sep = '_'))
}

# Replace in phyloseq object
sample_data(ps.protein) <- column_to_rownames(samdf.protein, var = 'row')
```

### Separate by kingdom

Need to think about how to transform data when doing a combined ordination on plant and animals (if this is even possible)???

For now I'm not certain, so splitting.
```{r}
nsamples(ps.protein)
```

```{r}
ps.protein.plant <- 
     ps.protein %>% 
     subset_taxa(kingdom == 'Viridiplantae') %>% 
     prune_samples(sample_sums(.) > 0, .)

ps.protein.plant
```

```{r}
ps.protein.animal <- 
     ps.protein %>% 
     subset_taxa(kingdom == 'Metazoa') %>% 
     prune_samples(sample_sums(.) > 0, .)
ps.protein.animal
```

```{r}
# What foods are left over?
ps.protein.other <- 
     ps.protein %>% 
     subset_taxa(!(kingdom %in% c('Viridiplantae',
                                  'Metazoa'))) 

ntaxa(ps.protein.other)
```

A few fungi, seaweeds (Rhodophyta), spirulina.  Might be fun to do an independent analysis of the prevalence of these taxa. 

# Analyze

## Ordinations

### Plant

##### PCA

```{r}
# CLR transform
ps.protein.plant.clr <- 
     microbiome::transform(ps.protein.plant,
                           transform = 'clr',
                           shift = 1)
```

```{r}
# PCA
pca <- prcomp(ps.protein.plant.clr@otu_table@.Data, 
              center = TRUE, 
              scale = FALSE)

pca.df <- 
        data.frame(pca$x) %>% 
        rownames_to_column(var = 'well')

# % variance explained
eigs <- pca$sdev^2
ve.pc1 <- as.character(100*round(eigs[1] / sum(eigs), 3))
ve.pc2 <- as.character(100*round(eigs[2] / sum(eigs), 3))

# Add back sample data
samdf <- 
     data.frame(ps.protein.plant@sam_data) %>% 
     rownames_to_column(var = 'well')

pca.df <- left_join(pca.df, samdf)

limit <- max(abs(pca.df[, c('PC1', 'PC2')])) +
          0.05*(max(abs(pca.df[, c('PC1', 'PC2')])))
```

```{r}
# Plot
pca.plot <- 
     ggplot(pca.df, aes(x = PC1, y = PC2, 
                        color = subj)) +
     geom_point(size = 3, alpha = 0.7) +
     coord_equal() +
     labs(x = paste0(' PC1 (', ve.pc1, '%)'),
          y = paste0(' PC2 (', ve.pc2, '%)')) +
     scale_color_manual(values = subj.colors) +
     xlim(-limit, limit) + ylim(-limit, limit) +
     theme(panel.grid = element_blank())

pca.plot
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '2',
            paste0(plotID, '_Plant metaproteomic ordination, all proteins (Aitchison).pdf')),
       device = cairo_pdf,
       height = 4, width = 4)
```

```{r}
samdf <- data.frame(ps.protein.plant@sam_data)
vegan::adonis(distance(ps.protein.plant.clr, 
                       method = 'euclidean') ~ subj, 
              data = samdf)
```

##### PCoA on Jaccard

```{r}
ord.protein.plant <- 
     ordinate(ps.protein.plant,
              method = 'PCoA',
              distance = 'jaccard',
              binary = TRUE)
```

```{r}
# Raw plot, to be re-done below
plot_ordination(ps.protein.plant,
                     ord.protein.plant,
                     type = 'samples',
                     color = 'subj') +
     scale_color_manual(values = subj.colors) 
```


```{r}
# Customize plot 
data <- data.frame(ord.protein.plant$vectors)
samdf.protein.plant <- data.frame(ps.protein.plant@sam_data)

data <- bind_cols(data, samdf.protein.plant)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (17.2%)',
          y = 'PCo2 (14.3%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme(legend.title = element_blank(),
           panel.grid = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Plant metaproteomic ordination, all proteins (Jaccard).pdf')),
       device = cairo_pdf,
       height = 4, width = 4)
```

```{r}
vegan::adonis(distance(ps.protein.plant, 
                       method = 'jaccard',
                       binary = TRUE) ~ subj,
              data = samdf.protein.plant)
```

### Animal

##### PCA

```{r}
# CLR transform
ps.protein.animal.clr <- 
     microbiome::transform(ps.protein.animal,
                           transform = 'clr',
                           shift = 1)
```

```{r}
# PCA
pca <- prcomp(ps.protein.animal.clr@otu_table@.Data, 
              center = TRUE, 
              scale = FALSE)

pca.df <- 
        data.frame(pca$x) %>% 
        rownames_to_column(var = 'well')

# % variance explained
eigs <- pca$sdev^2
ve.pc1 <- as.character(100*round(eigs[1] / sum(eigs), 3))
ve.pc2 <- as.character(100*round(eigs[2] / sum(eigs), 3))

# Add back sample data
samdf <- 
     data.frame(ps.protein.animal@sam_data) %>% 
     rownames_to_column(var = 'well')

pca.df <- left_join(pca.df, samdf)

limit <- max(abs(pca.df[, c('PC1', 'PC2')])) +
          0.05*(max(abs(pca.df[, c('PC1', 'PC2')])))
```

```{r}
# Plot
pca.plot <- 
     ggplot(pca.df, aes(x = PC1, y = PC2, 
                        color = subj)) +
     geom_point(size = 3, alpha = 0.7) +
     coord_equal() +
     labs(x = paste0(' PC1 (', ve.pc1, '%)'),
          y = paste0(' PC2 (', ve.pc2, '%)')) +
     scale_color_manual(values = subj.colors) +
     xlim(-limit, limit) + ylim(-limit, limit) +
     theme(panel.grid = element_blank())

pca.plot
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '2',
            paste0(plotID, '_animal metaproteomic ordination, all proteins (Aitchison).pdf')),
       device = cairo_pdf,
       height = 4, width = 4)
```

```{r}
samdf <- data.frame(ps.protein.animal@sam_data)
vegan::adonis(distance(ps.protein.animal.clr, 
                       method = 'euclidean') ~ subj, 
              data = samdf)
```

##### PCoA on Jaccard

```{r}
ord.protein.animal <- 
     ordinate(ps.protein.animal,
              method = 'PCoA',
              distance = 'jaccard',
              binary = TRUE)
```

```{r}
# Raw plot, to be re-done below
plot_ordination(ps.protein.animal,
                     ord.protein.animal,
                     type = 'samples',
                     color = 'subj') +
     scale_color_manual(values = subj.colors) 
```


```{r}
# Customize plot 
data <- data.frame(ord.protein.animal$vectors)
samdf.protein.animal <- data.frame(ps.protein.animal@sam_data)

data <- bind_cols(data, samdf.protein.animal)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (17.2%)',
          y = 'PCo2 (14.3%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme(legend.title = element_blank(),
           panel.grid = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Animal metaproteomic ordination, all proteins (Jaccard).pdf')),
       device = cairo_pdf,
       height = 4, width = 4)
```

```{r}
vegan::adonis(distance(ps.protein.animal, 
                       method = 'jaccard',
                       binary = TRUE) ~ subj,
              data = samdf.protein.animal)
```