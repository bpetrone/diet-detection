---
title: "Performance scatterplots"
output: html_notebook
---

# Setup

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r libraries, echo=FALSE}
library(here) 
library(phyloseq)
library(tidyverse)
```

```{r}
# Plotting themes
theme_set(theme_bw() +
               theme(
                    axis.text = element_text(size = 12),
                    axis.title.x = ggtext::element_markdown(size = 14),
                    axis.title.y = ggtext::element_markdown(size = 14),
                    legend.title = element_text(size = 12),
                    strip.text = element_text(size = 12)
               )
)
```

# Read in data

## Performance metrics

### "All taxa" comparison

```{r}
# This is both DNA and protein-based data in the same object
# Note: one entry per study
pred <-
     here('data',
          'processed',
          'performance-metrics',
          'DNA and protein v. menu predictions by shared food taxa, 1-2d prior, no intake filter.rds') |>
     readRDS()
```

### Glommed ranks

#### Metabarcoding performance metrics

```{r}
pred.mb.species <-
     here('data',
          'processed',
          'performance-metrics',
          'Metabarcoding v. menu predictions by shared food species, 1-2d prior, no intake filter.rds') %>%
     readRDS()

pred.mb.genus <-
     here('data',
          'processed',
          'performance-metrics',
          'Metabarcoding v. menu predictions by shared food genus, 1-2d prior, no intake filter.rds') %>%
     readRDS()

pred.mb.family <-
     here('data',
          'processed',
          'performance-metrics',
          'Metabarcoding v. menu predictions by shared food family, 1-2d prior, no intake filter.rds') %>%
     readRDS()
```

## Metaproteomic performance metrics

```{r}
# 1UP
pred.mp.species <- 
     here('data', 
          'processed',
          'performance-metrics',
          'Metaproteomic 1UP v. menu predictions by shared food species, 1-2d prior, >4 counts per taxon filter, no intake filter.rds') %>% 
     readRDS()

pred.mp.genus <- 
     here('data', 
          'processed',
          'performance-metrics',
          'Metaproteomic 1UP v. menu predictions by shared food genus, 1-2d prior, >4 counts per taxon filter, no intake filter.rds') %>% 
     readRDS()

pred.mp.family <- 
     here('data', 
          'processed',
          'performance-metrics',
          'Metaproteomic 1UP v. menu predictions by shared food family, 1-2d prior, >4 counts per taxon filter, no intake filter.rds') %>% 
     readRDS()
```

# Pre-process

## Tidy datasets

Note that data are formatted slightly differently between "all taxon" and grouped taxonomic rank:

```{r}
head(pred)
```
```{r}
head(pred.mb.species)
```

```{r}
# Rename variables in 'all' to sync
pred <- 
     pred |> 
     rename(name = common_name,
            count = n)
```

```{r}
# Summarize results across studies, indicate level
pred <- 
     pred |> 
     group_by(name,
              kingdom,
              marker,
              prediction) |> 
     summarize(count = sum(count)) |> 
     mutate(level = 'all')
```

```{r eval}
# For glommed data, annotate prior to joining
pred.mb.species$level <- 'species'
pred.mb.genus$level <- 'genus'
pred.mb.family$level <- 'family'

pred.mp.species$level <- 'species'
pred.mp.genus$level <- 'genus'
pred.mp.family$level <- 'family'
```

```{r}
# Combine glommed data
pred.mb <- 
     bind_rows(
          pred.mb.species,
          pred.mb.genus,
          pred.mb.family
     )

rm(pred.mb.species, pred.mb.genus, pred.mb.family)

pred.mp <- 
     bind_rows(
          pred.mp.species,
          pred.mp.genus,
          pred.mp.family
     )

rm(pred.mp.species, pred.mp.genus, pred.mp.family)
```

```{r}
# Annotate detection
pred.mb$marker <- 'DNA'
pred.mp$marker <- 'Protein'
```

```{r}
# Synchronize factor variables
pred.mb <- 
     pred.mb |> 
     mutate(prediction = factor(prediction,
                                levels = c('tp',
                                           'tn',
                                           'fp',
                                           'fn'),
                                labels = c('True positive',
                                           'True negative',
                                           'False positive',
                                           'False negative')),
            kingdom = factor(kingdom,
                             levels = c('Plants',
                                        'Animals',
                                        'Other')),
            marker = factor(marker,
                            levels = c('Protein',
                                       'DNA')))

pred.mp <- 
     pred.mp |> 
     # Predictions already factored
     mutate(kingdom = factor(kingdom,
                             levels = c('Plants',
                                        'Animals',
                                        'Other')),
            marker = factor(marker,
                            levels = c('Protein',
                                       'DNA')))
```

## Combine

```{r}
pred <- 
     pred |> 
     bind_rows(pred.mb) |> 
     bind_rows(pred.mp)

# Make final factor adjustment to level variable
pred$level <- factor(pred$level,
                     levels = c('all',
                                'family',
                                'genus',
                                'species'),
                     labels = c('All',
                                'Family',
                                'Genus',
                                'Species'))

rm(pred.mb, pred.mp)

pred
```

## Calculate summary metrics

Calculate FPR, FNR.

```{r}
# Shift data wide
pred.summary <- 
     pred %>% 
     pivot_wider(names_from = prediction, values_from = count) |> 
     # For simplicity
     rename(TP = `True positive`, TN = `True negative`,
            FP = `False positive`, FN = `False negative`) %>% 
     mutate(fpr = FP/(FP+TN),
            fnr = FN/(FN+TP),
            precision = TP/(TP+FP),
            recall = 1 - fnr)

pred.summary
```

# Visualize 

## FPR, FNR

```{r}
# Reshape data
false.rates <-
     pred.summary %>%
     select(-c(TN, TP, FN, FP)) |>
     pivot_longer(
          cols = c(fpr, fnr, precision, recall),
          names_to = 'stat',
          values_to = 'value') |>
     pivot_wider(names_from = marker,
                 values_from = value)
```

```{r}
# Plot 
ggplot(false.rates, aes(x = DNA, y = Protein, color = kingdom)) +
     geom_point(alpha = 0.5,
                size = 2) +
     facet_grid(rows = vars(stat),
                cols = vars(level)) +
     # geom_text(aes(label = common_name), angle = 20, hjust = 0) +
     scale_color_manual(values = c('#59a14f', '#e15759', 'gray50')) +
     coord_equal()
```

```{r}
# Stats
false.rates |> 
     group_by(stat, level) |> 
     summarize(rho = cor.test(DNA, Protein)$estimate,
               p = cor.test(DNA, Protein)$p.value,
               p_adj = p.adjust(p, method = 'BH'))
```

Interesting-- I thought FPR, FNR would be clearer, but actually much less so than precision and recall is 

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '3',
            paste0(plotID, '_Metaproteomic (1UP) x metabarcoding recall.pdf')),
       height = 4, width = 4)
```

## Between 1UP & 1PUP

```{r}
# Are there foods for which all entries are 0 (i.e., detected by DNA, but not by protein?)  Would want to remove these so as not to inflate the correlation 
drop <-
     pred.summary.long %>% 
     select(-DNA) %>% 
     group_by(common_name) %>% 
     filter(all(`Protein (1PUP)` == 0) & all(`Protein (1UP)` == 0)) %>% 
     pull(common_name) %>% 
     unique()

drop
```

```{r}
pred.summary.long %>% 
     filter(!(common_name %in% drop)) %>% 
     ggplot(aes(x = `Protein (1UP)`, 
                y = `Protein (1PUP)`)) +
     geom_point(alpha = 0.5) +
     coord_equal() +
     facet_wrap(~stat)
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'performance metrics', 
            paste0(plotID, '_Metaproteomic (1PUP) x metaproteomic (1UP) detactions.pdf')),
       height = 4, width = 4)
```

So we get an relative gain in positive detections for 1UP, or a relative gain in negative detections for 1PUP. 

```{r}
pred.summary %>% 
     filter(detection != 'DNA') %>% 
     ggplot(aes(x = 1-specificity, y = recall)) +
     geom_point(alpha = 0.5) +
     facet_wrap(~detection) +
     coord_equal()
```

```{r}
pred.summary %>% 
     filter(detection != 'DNA') %>% 
     ggplot(aes(x = f_measure)) +
     geom_histogram(binwidth = 0.05,
                    boundary = 1) +
     facet_wrap(~detection) 
```

```{r}
plot(ecdf(pred.summary[pred.summary$detection=="Protein (1PUP)",]$f_measure),
     col="green")
lines(ecdf(pred.summary[pred.summary$detection=="Protein (1UP)",]$f_measure),
      col="blue")
```


```{r}
ggplot(pred.summary, aes(y = f_measure, 
                         x = detection, 
                         fill = level)) +
     geom_boxplot(outlier.shape = NA) +
     # geom_point(alpha = 0.5, position = position_jitterdodge())
     labs(y = 'F measure', fill = 'Taxa in\nanalysis') +
     scale_fill_manual(values = c('gray90',
                                  'gray70',
                                  'gray50',
                                  'gray30')) +
     theme(axis.title.x = element_blank())
```
```{r}
anova(lm(f_measure ~ level * detection, data = pred.summary))
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '4',
            paste0(plotID, '_F measure by analysis.png')),
       height = 4, width = 5)
```

```{r}
# Higher for plant or animal taxa?
pred.summary %>% 
     group_by(detection, kingdom) %>% 
     summarize(mean(f_measure, na.rm = TRUE))
```

## Across measures

I'm going to say it's better to lean towards positive detections, and work with 1UP.

```{r}
pred.summary <-
     pred.summary %>%
     mutate(detection = case_when(detection == 'Protein (1UP)' ~ '1UP',
                                  detection == 'Protein (1PUP)' ~ '1PUP',
                                  TRUE ~ 'DNA')) %>% 
     select(-c(TP:FN, f_measure)) %>% 
     pivot_wider(names_from = detection,
                 values_from = recall:precision,
                 names_sep = '_') 
```

### Sensitivity, specificity

```{r}
ggplot(pred.summary, aes(x = recall_DNA, y = recall_1UP)) +
     geom_point(alpha = 0.5, aes(color = kingdom)) +
     # geom_text(aes(label = common_name), angle = 20, hjust = 0) +
     scale_color_manual(values = c('#59a14f', '#e15759', 'gray50')) +
     labs(x = 'Recall (DNA)', y = 'Recall (Protein)') +
     coord_equal()
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '3',
            paste0(plotID, '_Metaproteomic (1UP) x metabarcoding recall.pdf')),
       height = 4, width = 4)
```

```{r}
ggplot(pred.summary, aes(x = specificity_DNA, y = specificity_1PUP)) +
     geom_point(alpha = 0.5) +
     coord_equal()
```

```{r}
cor.test(pred.summary$recall_1UP,
         pred.summary$recall_DNA,
         method = 'spearman')
```

```{r}
cor.test(pred.summary$precision_1UP,
         pred.summary$precision_DNA,
         method = 'spearman')
```


### Recall, precision

```{r}
scatterplots.df <-
     pred.summary %>% 
     select(kingdom, name, level, detection, recall, precision) %>% 
     pivot_wider(values_from = c(recall, precision),
                 names_from = detection)

scatterplots.df
```
#### Precision 
```{r}
ggplot(scatterplots.df, aes(x = precision_DNA, y = precision_Protein)) +
     geom_point(alpha = 0.5, aes(color = kingdom)) +
     # geom_text(aes(label = common_name), angle = 20, hjust = 0) +
     facet_wrap(~level, nrow = 1) +
     scale_color_manual(values = c('#59a14f', '#e15759', 'gray50')) +
     labs(x = 'Precision (DNA)', y = 'Precision (Protein)', color = 'Food\nkingdom') +
     scale_x_continuous(breaks = seq(0, 1, 0.5),
                        labels = c('0', '0.5', '1')) +
     scale_y_continuous(breaks = seq(0, 1, 0.5),
                        labels = c('0', '0.5', '1')) +
     coord_equal()
```

```{r}
scatterplots.df %>% 
     group_by(level) %>% 
     summarize(rho = cor.test(~ precision_DNA + precision_Protein,
                              method = 'spearman')$estimate,
               p = cor.test(~ precision_DNA + precision_Protein,
                              method = 'spearman')$p.value)
```

```{r}
scatterplots.df %>% 
     group_by(level) %>% 
     summarize(rho = cor.test(~ recall_DNA + precision_Protein,
                              method = 'spearman')$estimate,
               p = cor.test(~ recall_DNA + precision_Protein,
                              method = 'spearman')$p.value)
```


```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '4',
            paste0(plotID, '_Metaproteomic x metabarcoding precision.pdf')),
       device = cairo_pdf,
       height = 4, width = 7)
```

#### Recall
```{r}
ggplot(scatterplots.df, aes(x = recall_DNA, y = recall_Protein)) +
     geom_point(alpha = 0.5, aes(color = kingdom)) +
     # geom_text(aes(label = common_name), angle = 20, hjust = 0) +
     facet_wrap(~level, nrow = 1) +
     scale_color_manual(values = c('#59a14f', '#e15759', 'gray50')) +
     scale_x_continuous(breaks = seq(0, 1, 0.5),
                        labels = c('0', '0.5', '1')) +
     scale_y_continuous(breaks = seq(0, 1, 0.5),
                        labels = c('0', '0.5', '1')) +
     labs(x = 'Recall (DNA)', y = 'Recall (Protein)', color = 'Food\nkingdom') +
     coord_equal()
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '4',
            paste0(plotID, '_Metaproteomic x metabarcoding recall.pdf')),
       device = cairo_pdf,
       height = 4, width = 7)
```

### Correlation by detection type

Need to fix NAs-- can be done by padding columns across all measures? 

```{r}
ggplot(pred.summary.long, aes(x = DNA, y = `Protein (1PUP)`)) +
     geom_point(alpha = 0.5) +
     coord_equal() +
     facet_wrap(~stat)
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'performance metrics', 
            paste0(plotID, '_Metaproteomic (1PUP) x metabarcoding detactions.pdf')),
       height = 4, width = 4)
```

```{r}
ggplot(pred.summary, aes(x = DNA, y = `Protein (1UP)`)) +
     geom_text(aes(label = common_name)) +
     facet_wrap(~stat)
```
```{r}
# Calculate correlation
pred.summary.long %>% 
     group_by(stat) %>%
     summarize(rho = cor.test(DNA, `Protein (1PUP)`,
                              method = 'spearman')$estimate,
               p = cor.test(DNA, `Protein (1PUP)`,
                            method = 'spearman')$p.value) 
```

Interesting!  They're all positive. 

### Expected prevalence

Thinking I'll do this as a Fisher exact test or a Chi squared test. 

```{r}
fisher.df <- 
     pred.summary %>% 
     mutate(pos = TP + FP,
            neg = TN + FN) %>% 
     select(common_name,
            detection, 
            pos,
            neg) 

fisher.df
```
```{r}
# Consider only those entries that are detected by both measures
fisher.df <-
     fisher.df %>% 
     group_by(common_name) %>% 
     filter(length(pos) == 2) %>% 
     ungroup()
```

```{r}
# Make dataframe for storing results
fisher.results <- 
     data.frame(common_name = NULL,
                p = NULL)

for (taxon in unique(fisher.df$common_name)){
     tab <- 
          fisher.df %>% 
          filter(common_name == taxon) %>% 
          select(detection, pos, neg) %>% 
          column_to_rownames(var = 'detection')
     
     row <- 
          data.frame(
               common_name = taxon,
               p = fisher.test(tab)$p.value
          )
     
     fisher.results <- bind_rows(fisher.results,
                                 row)
}
```

```{r}
# Correct p values
fisher.results <- 
     fisher.results %>% 
     # Adjust
     mutate(p.adj = p.adjust(p, method = 'BH')) %>%
     # Add kingdom
     left_join(distinct(select(pred.summary, kingdom, common_name))) 
```

```{r}
fisher.results
```
```{r}
# What proportion of tested foods are significant?
fisher.results %>% 
     group_by(p.adj <= 0.05) %>% 
     count() %>% 
     ungroup() %>% 
     mutate(proportion = n/sum(n))
```
```{r}
ggplot(fisher.results, aes(x = p.adj)) +
     geom_histogram(binwidth = 0.05,
                    boundary = 0) +
     facet_wrap(~kingdom) +
     labs(x = 'Fisher exact test *p*', y = 'Count')
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'performance metrics', 
            paste0(plotID, '_Fisher exact test p value distribution.pdf')),
       height = 2.5)
```


```{r}
t <- with(fisher.results, table(p.adj <= 0.05, kingdom))[, 
                                                         c('Viridiplantae',
                                                           'Metazoa')]

t
```

```{r}
fisher.test(t)
```

## Within measure

Note that F measure data isn't complete (when recall or precision is NA due to no detections in the denominator: either no actual positives, or no detected positives).

```{r}
ggplot(pred.summary, aes(x = f_measure)) +
     geom_histogram(binwidth = 0.1,
                    boundary = 0) +
     scale_y_continuous(breaks = seq(0, 15, by = 3)) +
     scale_x_continuous(labels = c('0', '0.25', '0.5', '0.75', '1')) +
     facet_grid(detection ~ kingdom) +
     labs(x = 'F measure', y = 'Foods (*n*)') 
     # theme(axis.text.x = element_text(angle = 20, hjust =))
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'performance metrics', 
            paste0(plotID, '_F measure histograms.pdf')),
       height = 4)
```

```{r}
# Wilcoxon signed rank
pred.summary %>% 
     # Format for test
     select(-c(recall, precision, TP:FN)) %>% 
     pivot_wider(names_from = detection, 
                 values_from = f_measure) %>% 
     # Recode NAs
     mutate(across(.cols = c(DNA, `Protein (1UP)`),
                   .fns = ~ ifelse(.x == 'NaN',
                                   yes = NA,
                                   no = .x))) %>% 
     wilcox.test(Pair(DNA, `Protein (1UP)`) ~ 1, 
                 data = .,
                 conf.int = TRUE)
```

## Combined

```{r}
ggplot(pred.summary, aes(x = sensitivity_DNA, y = sensitivity_pup,
                         label = taxon)) +
     annotate("rect", xmin = 0, xmax = 0.5, ymin = 0, ymax = 0.5, 
              fill= '#FDAE61', alpha = 0.5)  + 
     annotate("rect", xmin = 0.5, xmax = 1, ymin = 0, ymax = 0.5, 
              fill= '#A6D96A', alpha = 0.5)  + 
     annotate("rect", xmin = 0, xmax = 0.5, ymin = 0.5, ymax = 1, 
              fill= '#A6D96A', alpha = 0.5)  + 
     annotate("rect", xmin = 0.5, xmax = 1, ymin = 0.5, ymax = 1, 
              fill= '#1A9641', alpha = 0.5)  +
     geom_point(size = 2, alpha = 0.2) +
     geom_text(hjust = 0, nudge_x = 0.025, nudge_y = 0.01,
               angle = 20, check_overlap = TRUE) +
     coord_equal() +
     scale_x_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1.0),
                        limits = c(0, 1.15)) +
     scale_y_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1.0),
                        limits = c(0, 1.15)) +
     labs(x = 'Metabarcoding sensitivity', y = 'Metaproteomic sensitivity (PUP)') +
     theme_bw()

plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 'performance metrics', 
            paste0(plotID, '_Sensitivity scatterplot, protein v. DNA compared to menu (genus level).png')),
       height = 5, width = 5)
```

```{r}
ggplot(pred.summary, aes(x = specificity_DNA, y = specificity_pup,
                         label = taxon)) +
     annotate("rect", xmin = 0, xmax = 0.5, ymin = 0, ymax = 0.5, 
              fill= '#FDAE61', alpha = 0.5)  + 
     annotate("rect", xmin = 0.5, xmax = 1, ymin = 0, ymax = 0.5, 
              fill= '#A6D96A', alpha = 0.5)  + 
     annotate("rect", xmin = 0, xmax = 0.5, ymin = 0.5, ymax = 1, 
              fill= '#A6D96A', alpha = 0.5)  + 
     annotate("rect", xmin = 0.5, xmax = 1, ymin = 0.5, ymax = 1, 
              fill= '#1A9641', alpha = 0.5)  +
     geom_point(size = 2, alpha = 0.2) +
     coord_equal() +
     geom_text(hjust = 0, nudge_x = 0.025, nudge_y = 0.01,
               angle = 20, check_overlap = TRUE) +
     coord_equal() +
     scale_x_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1.0),
                        limits = c(0, 1.15)) +
     scale_y_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1.0),
                        limits = c(0, 1.15)) +
     labs(x = 'Metabarcoding specificity', y = 'Metaproteomic specificity (PUP)') +
     theme_bw()

plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 'performance metrics', 
            paste0(plotID, '_Specificity scatterplot, protein v. DNA compared to menu.png')),
       height = 5, width = 5)
```

## Plot statistics

Pearson correlations between per-taxon metrics
```{r}
# Sensitivity
cor.test(pred.summary$sensitivity_DNA,
         pred.summary$sensitivity_pup,
         alternative = 'two.sided',
         method = 'spearman')
```

```{r}
# Specificity
cor.test(pred.summary$specificity_DNA,
         pred.summary$specificity_pup,
         alternative = 'greater', 
         method = 'spearman')
```

# Animals vs plants?

```{r}
# Check rates of performance by taxon
pred.summary$kingdom <- factor(pred.summary$kingdom,
                               levels = c('Viridiplantae',
                                          'Metazoa',
                                          'Other'))
```
```{r}
ggplot(pred.summary, aes(x = kingdom, y = f_measure)) +
     geom_boxplot() +
     geom_jitter(alpha = 0.5, width = 0.1)
```
```{r}
plants <- filter(pred.summary, kingdom == 'Viridiplantae') %>% pull(f_measure)
animals <- filter(pred.summary, kingdom == 'Metazoa') %>% pull(f_measure)

wilcox.test(plants, animals, 
            paired = FALSE,
            conf.int = TRUE)
```
