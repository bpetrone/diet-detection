---
title: "Performance scatterplots"
output: html_notebook
---

# Setup

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r libraries, echo=FALSE}
library(here) 
library(phyloseq)
library(tidyverse)
```

```{r}
# Plotting themes
theme_set(theme_bw() +
               theme(
                    axis.text = element_text(size = 12),
                    axis.title.x = ggtext::element_markdown(size = 14),
                    axis.title.y = ggtext::element_markdown(size = 14),
                    legend.title = element_text(size = 12),
                    strip.text = element_text(size = 12)
               )
)
```

# Read in data

## Metabarcoding performance metrics

```{r}
# 1-2 days' prior menu, >4 counts per taxon
pred.mb <- 
     here('data', 
          'processed',
          'performance-metrics',
          'Metabarcoding v. menu predictions by shared food taxa, 1-2d prior, >4 counts per taxon filter, no intake filter.rds') %>%
     readRDS()
```

## Metaproteomic performance metrics

```{r}
# 1PUP
pred.mp.pup <- 
     here('data', 
          'processed',
          'performance-metrics',
          'Metaproteomic 1PUP v. menu predictions by shared food taxa, 1-2d prior, >4 counts per taxon filter, no intake filter.rds') %>% 
     readRDS()

# 1UP
pred.mp.up <- 
     here('data', 
          'processed',
          'performance-metrics',
          'Metaproteomic 1UP v. menu predictions by shared food taxa, 1-2d prior, >4 counts per taxon filter, no intake filter.rds') %>% 
     readRDS()
```

# Pre-process

```{r}
# Annotate each dataset prior to joining
pred.mb$detection <- 'DNA'
pred.mp.pup$detection <- 'Protein (1PUP)'
pred.mp.up$detection <- 'Protein (1UP)'
```

```{r}
# Get shared variables
vs <- 
     intersect(names(pred.mb), names(pred.mp.pup)) %>% 
     intersect(names(pred.mp.up))

# Just concatenate end to end for now
pred <- 
     bind_rows(select(pred.mb, one_of(vs)),
               select(pred.mp.pup, one_of(vs)),
               select(pred.mp.up, one_of(vs)))

pred
```
## Additional stats

Calculate F measure.

```{r}
# Need to shift data to wide form
pred <- pivot_wider(pred, names_from = prediction, values_from = count)
pred
```
```{r}
# Calculate recall (sensitivity), precision
pred.summary <- 
     pred %>% 
     rename(TP = `True positive`, TN = `True negative`,
            FP = `False positive`, FN = `False negative`) %>% 
     mutate(recall = TP/(TP + FN), 
            specificity = TN/(TN + FP),
            precision = TP/(TP + FP),
            f_measure = (2 * recall * precision)/(recall + precision))

pred.summary
```

```{r}
# Pivot longer
pred.summary.long <- 
     pred.summary %>% 
     select(-c(recall, precision, specificity, f_measure)) %>% 
     pivot_longer(cols = c(TP, TN, FP, FN),
                  names_to = 'stat',
                  values_to = 'value') %>% 
     pivot_wider(names_from = detection,
                 values_from = value,
                 values_fill = 0) %>% 
     mutate(stat = factor(stat,
                          levels = c('TP', 'TN', 'FP', 'FN'),
                          labels = c('True positive',
                                     'True negative',
                                     'False positive',
                                     'False negative')))

pred.summary.long
```
# Visualize 

## Between 1UP & 1PUP

```{r}
# Are there foods for which all entries are 0 (i.e., detected by DNA, but not by protein?)  Would want to remove these so as not to inflate the correlation 
drop <-
     pred.summary.long %>% 
     select(-DNA) %>% 
     group_by(common_name) %>% 
     filter(all(`Protein (1PUP)` == 0) & all(`Protein (1UP)` == 0)) %>% 
     pull(common_name) %>% 
     unique()

drop
```

```{r}
pred.summary.long %>% 
     filter(!(common_name %in% drop)) %>% 
     ggplot(aes(x = `Protein (1UP)`, 
                y = `Protein (1PUP)`)) +
     geom_point(alpha = 0.5) +
     coord_equal() +
     facet_wrap(~stat)
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'performance metrics', 
            paste0(plotID, '_Metaproteomic (1PUP) x metaproteomic (1UP) detactions.pdf')),
       height = 4, width = 4)
```

So we get an relative gain in positive detections for 1UP, or a relative gain in negative detections for 1PUP. 

```{r}
pred.summary %>% 
     filter(detection != 'DNA') %>% 
     ggplot(aes(x = 1-specificity, y = recall)) +
     geom_point(alpha = 0.5) +
     facet_wrap(~detection) +
     coord_equal()
```

```{r}
pred.summary %>% 
     filter(detection != 'DNA') %>% 
     ggplot(aes(x = f_measure)) +
     geom_histogram(binwidth = 0.05,
                    boundary = 1) +
     facet_wrap(~detection) 
```

```{r}
plot(ecdf(pred.summary[pred.summary$detection=="Protein (1PUP)",]$f_measure),
     col="green")
lines(ecdf(pred.summary[pred.summary$detection=="Protein (1UP)",]$f_measure),
      col="blue")
```

## Across measures

I'm going to say it's better to lean towards positive detections, and work with 1UP.

```{r}
pred.summary <-
     pred.summary %>%
     mutate(detection = case_when(detection == 'Protein (1UP)' ~ '1UP',
                                  detection == 'Protein (1PUP)' ~ '1PUP',
                                  TRUE ~ 'DNA')) %>% 
     select(-c(TP:FN, f_measure)) %>% 
     pivot_wider(names_from = detection,
                 values_from = recall:precision,
                 names_sep = '_') 
```

### Sensitivity, specificity

```{r}
ggplot(pred.summary, aes(x = recall_DNA, y = recall_1UP)) +
     geom_point(alpha = 0.5, aes(color = kingdom)) +
     # geom_text(aes(label = common_name), angle = 20, hjust = 0) +
     scale_color_manual(values = c('#59a14f', '#e15759', 'gray50')) +
     labs(x = 'Recall (DNA)', y = 'Recall (Protein)') +
     coord_equal()
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '3',
            paste0(plotID, '_Metaproteomic (1UP) x metabarcoding recall.pdf')),
       height = 4, width = 4)
```

```{r}
ggplot(pred.summary, aes(x = specificity_DNA, y = specificity_1PUP)) +
     geom_point(alpha = 0.5) +
     coord_equal()
```

```{r}
cor.test(pred.summary$recall_1UP,
         pred.summary$recall_DNA,
         method = 'spearman')
```

```{r}
cor.test(pred.summary$precision_1UP,
         pred.summary$precision_DNA,
         method = 'spearman')
```


### Recall, precision

```{r}
ggplot(pred.summary, aes(x = precision_DNA, y = precision_1UP)) +
     geom_point(alpha = 0.5, aes(color = kingdom)) +
     # geom_text(aes(label = common_name), angle = 20, hjust = 0) +
     scale_color_manual(values = c('#59a14f', '#e15759', 'gray50')) +
     labs(x = 'Precision (DNA)', y = 'Precision (Protein)') +
     coord_equal()
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '3',
            paste0(plotID, '_Metaproteomic (1UP) x metabarcoding precision.pdf')),
       height = 4, width = 4)
```


### Correlation by detection type

Need to fix NAs-- can be done by padding columns across all measures? 

```{r}
ggplot(pred.summary.long, aes(x = DNA, y = `Protein (1PUP)`)) +
     geom_point(alpha = 0.5) +
     coord_equal() +
     facet_wrap(~stat)
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'performance metrics', 
            paste0(plotID, '_Metaproteomic (1PUP) x metabarcoding detactions.pdf')),
       height = 4, width = 4)
```

```{r}
ggplot(pred.summary, aes(x = DNA, y = `Protein (1UP)`)) +
     geom_text(aes(label = common_name)) +
     facet_wrap(~stat)
```
```{r}
# Calculate correlation
pred.summary.long %>% 
     group_by(stat) %>%
     summarize(rho = cor.test(DNA, `Protein (1PUP)`,
                              method = 'spearman')$estimate,
               p = cor.test(DNA, `Protein (1PUP)`,
                            method = 'spearman')$p.value) 
```

Interesting!  They're all positive. 

### Expected prevalence

Thinking I'll do this as a Fisher exact test or a Chi squared test. 

```{r}
fisher.df <- 
     pred.summary %>% 
     mutate(pos = TP + FP,
            neg = TN + FN) %>% 
     select(common_name,
            detection, 
            pos,
            neg) 

fisher.df
```
```{r}
# Consider only those entries that are detected by both measures
fisher.df <-
     fisher.df %>% 
     group_by(common_name) %>% 
     filter(length(pos) == 2) %>% 
     ungroup()
```

```{r}
# Make dataframe for storing results
fisher.results <- 
     data.frame(common_name = NULL,
                p = NULL)

for (taxon in unique(fisher.df$common_name)){
     tab <- 
          fisher.df %>% 
          filter(common_name == taxon) %>% 
          select(detection, pos, neg) %>% 
          column_to_rownames(var = 'detection')
     
     row <- 
          data.frame(
               common_name = taxon,
               p = fisher.test(tab)$p.value
          )
     
     fisher.results <- bind_rows(fisher.results,
                                 row)
}
```

```{r}
# Correct p values
fisher.results <- 
     fisher.results %>% 
     # Adjust
     mutate(p.adj = p.adjust(p, method = 'BH')) %>%
     # Add kingdom
     left_join(distinct(select(pred.summary, kingdom, common_name))) 
```

```{r}
fisher.results
```
```{r}
# What proportion of tested foods are significant?
fisher.results %>% 
     group_by(p.adj <= 0.05) %>% 
     count() %>% 
     ungroup() %>% 
     mutate(proportion = n/sum(n))
```
```{r}
ggplot(fisher.results, aes(x = p.adj)) +
     geom_histogram(binwidth = 0.05,
                    boundary = 0) +
     facet_wrap(~kingdom) +
     labs(x = 'Fisher exact test *p*', y = 'Count')
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'performance metrics', 
            paste0(plotID, '_Fisher exact test p value distribution.pdf')),
       height = 2.5)
```


```{r}
t <- with(fisher.results, table(p.adj <= 0.05, kingdom))[, 
                                                         c('Viridiplantae',
                                                           'Metazoa')]

t
```

```{r}
fisher.test(t)
```

## Within measure

Note that F measure data isn't complete (when recall or precision is NA due to no detections in the denominator: either no actual positives, or no detected positives).

```{r}
ggplot(pred.summary, aes(x = f_measure)) +
     geom_histogram(binwidth = 0.1,
                    boundary = 0) +
     scale_y_continuous(breaks = seq(0, 15, by = 3)) +
     scale_x_continuous(labels = c('0', '0.25', '0.5', '0.75', '1')) +
     facet_grid(detection ~ kingdom) +
     labs(x = 'F measure', y = 'Foods (*n*)') 
     # theme(axis.text.x = element_text(angle = 20, hjust =))
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'performance metrics', 
            paste0(plotID, '_F measure histograms.pdf')),
       height = 4)
```

```{r}
# Wilcoxon signed rank
pred.summary %>% 
     # Format for test
     select(-c(recall, precision, TP:FN)) %>% 
     pivot_wider(names_from = detection, 
                 values_from = f_measure) %>% 
     # Recode NAs
     mutate(across(.cols = c(DNA, `Protein (1UP)`),
                   .fns = ~ ifelse(.x == 'NaN',
                                   yes = NA,
                                   no = .x))) %>% 
     wilcox.test(Pair(DNA, `Protein (1UP)`) ~ 1, 
                 data = .,
                 conf.int = TRUE)
```

## Combined

```{r}
ggplot(pred.summary, aes(x = sensitivity_DNA, y = sensitivity_pup,
                         label = taxon)) +
     annotate("rect", xmin = 0, xmax = 0.5, ymin = 0, ymax = 0.5, 
              fill= '#FDAE61', alpha = 0.5)  + 
     annotate("rect", xmin = 0.5, xmax = 1, ymin = 0, ymax = 0.5, 
              fill= '#A6D96A', alpha = 0.5)  + 
     annotate("rect", xmin = 0, xmax = 0.5, ymin = 0.5, ymax = 1, 
              fill= '#A6D96A', alpha = 0.5)  + 
     annotate("rect", xmin = 0.5, xmax = 1, ymin = 0.5, ymax = 1, 
              fill= '#1A9641', alpha = 0.5)  +
     geom_point(size = 2, alpha = 0.2) +
     geom_text(hjust = 0, nudge_x = 0.025, nudge_y = 0.01,
               angle = 20, check_overlap = TRUE) +
     coord_equal() +
     scale_x_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1.0),
                        limits = c(0, 1.15)) +
     scale_y_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1.0),
                        limits = c(0, 1.15)) +
     labs(x = 'Metabarcoding sensitivity', y = 'Metaproteomic sensitivity (PUP)') +
     theme_bw()

plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 'performance metrics', 
            paste0(plotID, '_Sensitivity scatterplot, protein v. DNA compared to menu (genus level).png')),
       height = 5, width = 5)
```

```{r}
ggplot(pred.summary, aes(x = specificity_DNA, y = specificity_pup,
                         label = taxon)) +
     annotate("rect", xmin = 0, xmax = 0.5, ymin = 0, ymax = 0.5, 
              fill= '#FDAE61', alpha = 0.5)  + 
     annotate("rect", xmin = 0.5, xmax = 1, ymin = 0, ymax = 0.5, 
              fill= '#A6D96A', alpha = 0.5)  + 
     annotate("rect", xmin = 0, xmax = 0.5, ymin = 0.5, ymax = 1, 
              fill= '#A6D96A', alpha = 0.5)  + 
     annotate("rect", xmin = 0.5, xmax = 1, ymin = 0.5, ymax = 1, 
              fill= '#1A9641', alpha = 0.5)  +
     geom_point(size = 2, alpha = 0.2) +
     coord_equal() +
     geom_text(hjust = 0, nudge_x = 0.025, nudge_y = 0.01,
               angle = 20, check_overlap = TRUE) +
     coord_equal() +
     scale_x_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1.0),
                        limits = c(0, 1.15)) +
     scale_y_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1.0),
                        limits = c(0, 1.15)) +
     labs(x = 'Metabarcoding specificity', y = 'Metaproteomic specificity (PUP)') +
     theme_bw()

plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 'performance metrics', 
            paste0(plotID, '_Specificity scatterplot, protein v. DNA compared to menu.png')),
       height = 5, width = 5)
```

## Plot statistics

Pearson correlations between per-taxon metrics
```{r}
# Sensitivity
cor.test(pred.summary$sensitivity_DNA,
         pred.summary$sensitivity_pup,
         alternative = 'two.sided',
         method = 'spearman')
```

```{r}
# Specificity
cor.test(pred.summary$specificity_DNA,
         pred.summary$specificity_pup,
         alternative = 'greater', 
         method = 'spearman')
```

