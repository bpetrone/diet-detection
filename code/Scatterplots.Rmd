---
title: "Performance scatterplots"
output: html_notebook
---

# Setup

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r libraries, echo=FALSE}
library(here) 
library(phyloseq)
library(tidyverse)
```

```{r}
# Plotting themes
theme_set(theme_bw() +
               theme(
                    axis.text = element_text(size = 12),
                    axis.title.x = ggtext::element_markdown(size = 14),
                    axis.title.y = ggtext::element_markdown(size = 14),
                    legend.title = element_text(size = 12),
                    strip.text = element_text(size = 12)
               )
)
```

# Read in data

## Performance metrics

### "All taxa" comparison

```{r}
# This is both DNA and protein-based data in the same object
# Note: one entry per study
pred <-
     here('data',
          'processed',
          'performance-metrics',
          'DNA and protein v. menu predictions by shared food taxa, 1-2d prior, no intake filter.rds') |>
     readRDS()
```

### Glommed ranks

#### Metabarcoding performance metrics

```{r}
pred.mb.species <-
     here('data',
          'processed',
          'performance-metrics',
          'Metabarcoding v. menu predictions by shared food species, 1-2d prior, no intake filter.rds') %>%
     readRDS()

pred.mb.genus <-
     here('data',
          'processed',
          'performance-metrics',
          'Metabarcoding v. menu predictions by shared food genus, 1-2d prior, no intake filter.rds') %>%
     readRDS()

pred.mb.family <-
     here('data',
          'processed',
          'performance-metrics',
          'Metabarcoding v. menu predictions by shared food family, 1-2d prior, no intake filter.rds') %>%
     readRDS()
```

## Metaproteomic performance metrics

```{r}
# 1UP
pred.mp.species <- 
     here('data', 
          'processed',
          'performance-metrics',
          'Metaproteomic 1UP v. menu predictions by shared food species, 1-2d prior, >4 counts per taxon filter, no intake filter.rds') %>% 
     readRDS()

pred.mp.genus <- 
     here('data', 
          'processed',
          'performance-metrics',
          'Metaproteomic 1UP v. menu predictions by shared food genus, 1-2d prior, >4 counts per taxon filter, no intake filter.rds') %>% 
     readRDS()

pred.mp.family <- 
     here('data', 
          'processed',
          'performance-metrics',
          'Metaproteomic 1UP v. menu predictions by shared food family, 1-2d prior, >4 counts per taxon filter, no intake filter.rds') %>% 
     readRDS()
```

# Pre-process

## Tidy datasets

Note that data are formatted slightly differently between "all taxon" and grouped taxonomic rank:

```{r}
head(pred)
```
```{r}
head(pred.mb.species)
```

```{r}
# Rename variables in 'all' to sync
pred <- 
     pred |> 
     rename(name = common_name,
            count = n)
```

```{r}
# Summarize results across studies, indicate level
pred <- 
     pred |> 
     group_by(name,
              kingdom,
              marker,
              prediction) |> 
     summarize(count = sum(count)) |> 
     mutate(level = 'all')
```

```{r eval}
# For glommed data, annotate prior to joining
pred.mb.species$level <- 'species'
pred.mb.genus$level <- 'genus'
pred.mb.family$level <- 'family'

pred.mp.species$level <- 'species'
pred.mp.genus$level <- 'genus'
pred.mp.family$level <- 'family'
```

```{r}
# Combine glommed data
pred.mb <- 
     bind_rows(
          pred.mb.species,
          pred.mb.genus,
          pred.mb.family
     )

rm(pred.mb.species, pred.mb.genus, pred.mb.family)

pred.mp <- 
     bind_rows(
          pred.mp.species,
          pred.mp.genus,
          pred.mp.family
     )

rm(pred.mp.species, pred.mp.genus, pred.mp.family)
```

```{r}
# Annotate detection
pred.mb$marker <- 'DNA'
pred.mp$marker <- 'Protein'
```

```{r}
# Synchronize factor variables
pred.mb <- 
     pred.mb |> 
     mutate(prediction = factor(prediction,
                                levels = c('tp',
                                           'tn',
                                           'fp',
                                           'fn'),
                                labels = c('True positive',
                                           'True negative',
                                           'False positive',
                                           'False negative')),
            kingdom = factor(kingdom,
                             levels = c('Plants',
                                        'Animals',
                                        'Other')),
            marker = factor(marker,
                            levels = c('Protein',
                                       'DNA')))

pred.mp <- 
     pred.mp |> 
     # Predictions already factored
     mutate(kingdom = factor(kingdom,
                             levels = c('Plants',
                                        'Animals',
                                        'Other')),
            marker = factor(marker,
                            levels = c('Protein',
                                       'DNA')))
```

## Combine

```{r}
pred <- 
     pred |> 
     bind_rows(pred.mb) |> 
     bind_rows(pred.mp)

# Make final factor adjustment to level variable
pred$level <- factor(pred$level,
                     levels = c('all',
                                'family',
                                'genus',
                                'species'),
                     labels = c('All',
                                'Family',
                                'Genus',
                                'Species'))

rm(pred.mb, pred.mp)

pred
```

## Calculate summary metrics

Calculate FPR, FNR.

```{r}
# Shift data wide
pred.summary <- 
     pred %>% 
     pivot_wider(names_from = prediction, values_from = count) |> 
     # For simplicity
     rename(TP = `True positive`, TN = `True negative`,
            FP = `False positive`, FN = `False negative`) %>% 
     mutate(fpr = FP/(FP+TN),
            fnr = FN/(FN+TP),
            precision = TP/(TP+FP),
            recall = 1 - fnr)

pred.summary
```

# Visualize 

## FPR, FNR

```{r}
# Reshape data
false.rates <-
     pred.summary %>%
     select(-c(TN, TP, FN, FP)) |>
     pivot_longer(
          cols = c(fpr, fnr, precision, recall),
          names_to = 'stat',
          values_to = 'value') |>
     pivot_wider(names_from = marker,
                 values_from = value)
```

```{r}
# Plot 
ggplot(false.rates, aes(x = DNA, y = Protein, color = kingdom)) +
     geom_point(alpha = 0.5,
                size = 2) +
     facet_grid(rows = vars(stat),
                cols = vars(level)) +
     # geom_text(aes(label = common_name), angle = 20, hjust = 0) +
     scale_color_manual(values = c('#59a14f', '#e15759', 'gray50')) +
     coord_equal()
```

```{r}
# Stats
false.rates |> 
     group_by(stat, level) |> 
     summarize(rho = cor.test(DNA, Protein)$estimate,
               p = cor.test(DNA, Protein)$p.value,
               p_adj = p.adjust(p, method = 'BH'))
```

Interesting-- I thought FPR, FNR would be clearer, but actually much less so than precision and recall is 

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '3',
            paste0(plotID, '_Metaproteomic (1UP) x metabarcoding recall.pdf')),
       height = 4, width = 4)
```

## Between 1UP & 1PUP

```{r}
# Are there foods for which all entries are 0 (i.e., detected by DNA, but not by protein?)  Would want to remove these so as not to inflate the correlation 
drop <-
     pred.summary.long %>% 
     select(-DNA) %>% 
     group_by(common_name) %>% 
     filter(all(`Protein (1PUP)` == 0) & all(`Protein (1UP)` == 0)) %>% 
     pull(common_name) %>% 
     unique()

drop
```

```{r}
pred.summary.long %>% 
     filter(!(common_name %in% drop)) %>% 
     ggplot(aes(x = `Protein (1UP)`, 
                y = `Protein (1PUP)`)) +
     geom_point(alpha = 0.5) +
     coord_equal() +
     facet_wrap(~stat)
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'performance metrics', 
            paste0(plotID, '_Metaproteomic (1PUP) x metaproteomic (1UP) detactions.pdf')),
       height = 4, width = 4)
```

So we get an relative gain in positive detections for 1UP, or a relative gain in negative detections for 1PUP. 

```{r}
pred.summary %>% 
     filter(detection != 'DNA') %>% 
     ggplot(aes(x = 1-specificity, y = recall)) +
     geom_point(alpha = 0.5) +
     facet_wrap(~detection) +
     coord_equal()
```

```{r}
pred.summary %>% 
     filter(detection != 'DNA') %>% 
     ggplot(aes(x = f_measure)) +
     geom_histogram(binwidth = 0.05,
                    boundary = 1) +
     facet_wrap(~detection) 
```

```{r}
plot(ecdf(pred.summary[pred.summary$detection=="Protein (1PUP)",]$f_measure),
     col="green")
lines(ecdf(pred.summary[pred.summary$detection=="Protein (1UP)",]$f_measure),
      col="blue")
```


```{r}
ggplot(pred.summary, aes(y = f_measure, 
                         x = detection, 
                         fill = level)) +
     geom_boxplot(outlier.shape = NA) +
     # geom_point(alpha = 0.5, position = position_jitterdodge())
     labs(y = 'F measure', fill = 'Taxa in\nanalysis') +
     scale_fill_manual(values = c('gray90',
                                  'gray70',
                                  'gray50',
                                  'gray30')) +
     theme(axis.title.x = element_blank())
```
```{r}
anova(lm(f_measure ~ level * detection, data = pred.summary))
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '4',
            paste0(plotID, '_F measure by analysis.png')),
       height = 4, width = 5)
```

# Animals vs plants?

```{r}
# Check rates of performance by taxon
pred.summary$kingdom <- factor(pred.summary$kingdom,
                               levels = c('Viridiplantae',
                                          'Metazoa',
                                          'Other'))
```
```{r}
ggplot(pred.summary, aes(x = kingdom, y = f_measure)) +
     geom_boxplot() +
     geom_jitter(alpha = 0.5, width = 0.1)
```
```{r}
plants <- filter(pred.summary, kingdom == 'Viridiplantae') %>% pull(f_measure)
animals <- filter(pred.summary, kingdom == 'Metazoa') %>% pull(f_measure)

wilcox.test(plants, animals, 
            paired = FALSE,
            conf.int = TRUE)
```
