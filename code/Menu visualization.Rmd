---
title: "Visualize menu data"
output: html_notebook
---

## Setup

```{r setup}
require(knitr)
knitr::opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r}
library(cowplot)
library(ggdendro)
library(here)
library(phyloseq)
library(tidyverse)
```

```{r}
# Plotting themes
theme_set(theme_bw() +
               theme(
                    axis.text = element_text(size = 12),
                    axis.title.x = ggtext::element_markdown(size = 14,
                                                            face = 'bold'),
                    axis.title.y = ggtext::element_markdown(size = 14,
                                                            face = 'bold'),
                    legend.title = element_text(size = 12,
                                                face = 'bold'),
                    strip.text = element_text(size = 12,
                                              face = 'bold')
               )
)
```

## Read in data

### Menu data

```{r}
# Tax-glommed
ps.protein <- 
     here('data',
          'processed',
          'phyloseq',
          'combined',
          'filtered',
          'ps_mp_1UP_taxa.rds') %>%
     readRDS()

ps.protein
```

```{r}
ps.menu <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'filtered',
          'ps_menu.rds') %>% 
     readRDS()

ps.menu
```

### Common names

```{r}
name.sync <- 
     here('data',
          'processed',
          'Naming discrepancies.xlsx') %>% 
     readxl::read_excel()

name.sync
```

## Pre-process

### List samples

ML48 (10/17/19) omitted due to low spectra counts and poor extraction.

```{r}
samdf.protein <- data.frame(ps.protein@sam_data)
samdf.protein
```
```{r}
# Add missing sample
row <- 
     data.frame(subj = 'ML48',
                date = as.Date('2019-10-17'),
                study = 'Intervention',
                time = NA
     ) %>% 
     mutate(delta1 = paste(subj, date-1, sep = '_'),
            delta2 = paste(subj, date-2, sep = '_'))

row.names(row) <- paste(row$subj, 
                        row$date,
                        sep = '_')

row
```
```{r}
samdf.protein <- 
     bind_rows(samdf.protein, row) %>% 
     rownames_to_column(var = 'row')
```

### Rename taxa

```{r}
# Menu
# Needs name column added
tax_table(ps.menu) <- 
     MButils::lowest_level(data.frame(ps.menu@tax_table@.Data)) %>% 
     as.matrix()

tax_table(ps.menu) <- 
     name.sync %>% 
     # common_names column (vs "common_name") contains the disaggregated
     # common names, even within metabarcoding groups
     select(common_names, menu_taxa) %>% 
     right_join(data.frame(ps.menu@tax_table@.Data), 
               by = c('menu_taxa' = 'name')) %>% 
     distinct() %>% 
     select(superkingdom:phylum, common_names, menu_taxa) %>%
     column_to_rownames(var = 'menu_taxa') %>% 
     as.matrix()

ps.menu <- tax_glom(ps.menu, taxrank = 'common_names')
taxa_names(ps.menu) <- tax_table(ps.menu)[, 'common_names']
```

### 1-2 days' prior

Maybe 1 day prior to sampling would be better, so foods are not shared between rows? i.e., if samples are from consecutive days, will happen that comparison menu for day 1 [*day 0* and day -1] will overlap with menu for day 2 [day 1 and *day 0*], making them seem more similar.  Here, we care more about similarity between individual menu days.

```{r}
# 1 day prior
ps.menu.subset <- 
     ps.menu %>% 
     prune_samples(samdf.protein$delta1, .) %>% 
     prune_taxa(taxa_sums(.) > 0, .)

ps.menu.subset
```

## Visualize

First pass

```{r}
melt <- psmelt(ps.menu.subset)
```

```{r}
ggplot(melt, aes(x = OTU, y = Sample, fill = Abundance>0)) +
     geom_tile() +
     scale_fill_manual(values = c('white', '#7e756d')) +
     theme(axis.text.y = element_blank(),
           axis.ticks.y = element_blank())
```

## Add dendrogram

### Samples
```{r}
# Run clustering
menu.dat <- as.matrix(ps.menu.subset@otu_table@.Data)
# Make data binary:
menu.dat[menu.dat > 0] <- 1
menu.dendro <- 
     dist(menu.dat) %>% 
     hclust() %>% 
     as.dendrogram()

# Create dendro
dendro.plot.y <- ggdendrogram(data = menu.dendro, rotate = TRUE)

# Preview the plot
print(dendro.plot.y)
```

```{r}
# Re-order samples to match
menu.order <- order.dendrogram(menu.dendro)
menu.order

melt <- 
     mutate(melt,
            Sample = factor(Sample,
                            levels = row.names(menu.dat[menu.order, ])))
```

### Foods 

```{r}
# Run clustering
menu.dat <- as.matrix(ps.menu.subset@otu_table@.Data)
# Make data binary:
menu.dat[menu.dat > 0] <- 1
```
```{r}
# Build dendrogram
menu.dendro <- 
     menu.dat %>% 
     t() %>% 
     dist() %>% 
     hclust() %>% 
     as.dendrogram()

menu.dendro.data <- dendro_data(menu.dendro, type = 'rectangle')
str(menu.dendro.data)
```

```{r}
# Add taxonomic kingdom
kingdoms <- 
     melt %>% 
     select(label = OTU, kingdom) %>% 
     distinct() %>% 
     mutate(kingdom = ifelse(kingdom == 'Fungi' | is.na(kingdom),
                             yes = 'Other',
                             no = kingdom))

menu.dendro.data$labels <- left_join(menu.dendro.data$labels, kingdoms)
```

```{r}
menu.plot <- 
     ggplot(menu.dendro.data$segments) + 
     geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) +
     geom_tile(data = menu.dendro.data$labels,
               aes(x, y, fill = kingdom),
               height = 0.2) +
     scale_fill_manual(values = c('#b66353',
                                  '#d7ce9f',
                                  '#638b66')) 
  # geom_text(data = menu.dendro.data$labels, aes(x, y, label = label),
  #           hjust = 1, angle = 90, size = 3) 
```

```{r}
# Re-order samples to match
menu.order <- order.dendrogram(menu.dendro)
menu.order

melt <- 
     mutate(melt,
            OTU = factor(OTU,
                         levels = colnames(menu.dat[, rev(menu.order)])))
```

## Joint plot

```{r}
# Now, update original heatmap with these new levels
heatmap <- 
     ggplot(melt, aes(x = Sample, y = OTU, fill = Abundance>0)) +
     geom_tile() +
     scale_fill_manual(values = c('white', '#7e756d')) +
     coord_equal() +
     theme(axis.text = element_blank(),
           axis.ticks = element_blank(),
           legend.position = 'none') 

heatmap
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript', 
            '1',
            paste0(plotID, '_Menu visualization.pdf')),
       height = 8)
```

```{r}
plot_grid(menu.plot,
          heatmap,
          aligh = 'h')
```

