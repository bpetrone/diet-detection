---
title: "Estimating individualized transit times"
author: "Brianna Petrone"
output: html_notebook
---

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r}
library(here)
library(phyloseq)
library(tidyverse)
```

## Read in files

## Taxon name mapping

```{r}
name.sync <- 
     here('data',
          'processed',
          'Naming discrepancies.xlsx') %>% 
     readxl::read_excel()

name.sync
```

### Metaproteomic

```{r}
ps.protein <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'filtered',
          # 'ps_mp_1PUP.rds') %>% # >=1 protein unique peptide
          'ps_mp_1UP.rds') %>% # >=1 unique peptide
     readRDS()
          
ps.protein
```

### Menu

```{r}
ps.menu <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'filtered',
          'ps_menu.rds') %>% 
     readRDS()

ps.menu
```

### Metabarcoding phyloseqs


```{r}
ps.mb.plant <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'filtered',
          'ps_mb_trnL.rds') %>% 
     readRDS()

ps.mb.plant
```

```{r}
ps.mb.animal <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'filtered',
          'ps_mb_12SV5.rds') %>% 
     readRDS()

ps.mb.plant
```

## Pre-process

### Melt 
```{r}
melt.menu <- psmelt(ps.menu) 
melt.mb.plant <- psmelt(ps.mb.plant)
melt.mb.animal <- psmelt(ps.mb.animal)
melt.mp <- psmelt(ps.protein)
```

#### Add common name
Add common name and group by dataset:

```{r}
melt.menu <- 
     melt.menu %>% 
     left_join(select(name.sync,
                      menu_taxa, common_name),
               by = c('OTU' = 'menu_taxa'))

melt.mb.animal <- 
     melt.mb.animal %>% 
     left_join(select(name.sync,
                      mb_taxa, common_name),
               by = c('OTU' = 'mb_taxa'))

melt.mb.plant <- 
     melt.mb.plant %>% 
     left_join(select(name.sync,
                      mb_taxa, common_name),
               by = c('OTU' = 'mb_taxa'))

# Note column naming differences for metaproteomics
melt.mp <- 
     melt.mp %>% 
     left_join(select(name.sync,
                      mp_taxa, common_name),
               by = c('name' = 'mp_taxa'))
```

#### Add detection method

```{r}
# Add dataset info to each melted object
# melt.menu$detection <-  'Menu'
melt.menu$detection <- 'Menu'
melt.mb.plant$detection <- 'DNA'
melt.mb.animal$detection <- 'DNA'
melt.mp$detection <- 'Protein'
```

#### Join melts

```{r}
melts <- list(
     melt.menu, # Full menu
     melt.mb.animal,
     melt.mb.plant,
     melt.mp)
```

```{r}
vs <- c('study',
        'subj', 
        'date',
        'detection', 
        'common_name', 
        'Abundance') # Shared variables to pull from each phyloseq

lapply(melts, ncol)
melts <- lapply(melts, function(x){select(x, one_of(vs))})
lapply(melts, ncol)
```

```{r}
melt <- bind_rows(melts)
dim(melt)
rm(melts)
```

```{r}
melt$detection <- factor(melt$detection, 
                         levels = c('Menu',
                                    'DNA',
                                    'Protein'))
```

## Analyze

### Find uniquely detected foods

```{r}
subjects <- unique(melt$subj)
subjects
```

```{r}
# Helper function to find uniquely detected foods for a given subject
get_unique <- function(ps, subject){
     # Input: a phyloseq object and the subject of interest
     # Returns: a taxonomy table containing only those taxa detected in
     # a single sample
     
     # Subset to only the subject desired
     ps <- subset_samples(ps, subj == subject)
     # Get their ASV table
     asvtab <- otu_table(ps)@.Data

     uniques <- names(which(colSums(asvtab > 0) == 1))
     uniques
}
```

### Metaproteomic

```{r}
# For storing results
uniques.protein <- data.frame()

# Find unique foods for each subject
for (subject in subjects){
     uniques.protein <- 
          # Get uniques.protein
          data.frame(subj = subject, 
                     food = get_unique(ps.protein, subject)) %>% 
          # Add to results dataframe
          bind_rows(uniques.protein, .)
}
```

```{r}
# Do any of these come up in all four subjects?
uniques.protein %>% 
     group_by(food) %>% 
     count() %>% 
     filter(n > 1)
```

```{r}
# Add PSM counts
melt.protein <- psmelt(ps.protein)

uniques.protein <- 
     melt.protein %>% 
     filter(Abundance != 0) %>% 
     select(subj, Sample, food = OTU, Abundance) %>% 
     right_join(uniques.protein, by = c('subj', 'food')) %>% 
     arrange(subj, desc(Abundance))
```

Follow-on thoughts: 
* How believable is the signal in each case? 
     + Is it abundant? (High number of PSMs)?
     + Is it backed up by menu data/trnL? (Menu data would be the necessary feature to get at transit time).
     
```{r}
# How to connect to menu data? Visually?
# Refactor food by count
foods.desc <- 
     uniques.protein %>% 
     group_by(food) %>% 
     summarize(tot.psms = sum(Abundance)) %>% 
     arrange(desc(tot.psms))

uniques.protein$food <- factor(uniques.protein$food,
                       levels = foods.desc$food)

rm(foods.desc)
```

```{r}
# Only foods with >5 counts, per input from Ali
uniques.protein %>% 
     filter(Abundance > 4) %>% 
     ggplot(aes(x = food, y = Abundance)) +
     geom_bar(stat = 'identity') +
     facet_wrap(~subj, scales = 'free', ncol = 1) +
     labs(y = 'Total PSMs\n\n\n') +
     theme_bw() +
     theme(axis.text.x = element_text(angle = 20,
                                      hjust = 1),
           axis.title.x = element_blank(),
           plot.margin = unit(c(1, 1, 1.5, 1.5), "cm"))
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

# 2021-03-12.132: First pass (>5 PSMs/taxon filter)
# 2021-04-09.100: Database v2, >4 PSMs/taxon filter

ggsave(here('results', 'transit time',
            paste0(plotID, '_Unique foods per-participant, with PSMs.png')),
       height = 8, width = 4.5)
```

### Metabarcoding

#### trnL

```{r}
# Update subject to subj to be compatible with function
samdf.trnL <- as(sample_data(ps.trnL), 'data.frame')
samdf.trnL <- rename(samdf.trnL, subj = subject)

sample_data(ps.trnL) <- samdf.trnL
```

```{r}
# For storing results
uniques.trnL <- data.frame()

# Find unique foods for each subject
# Note!! JN55 not sequenced here
# TODO: Repeat once JN55 added to phyloseq object
for (subject in c('AK65', 'ML48', 'PC74')){
     uniques.trnL <- 
          # Get uniques.trnL
          data.frame(subj = subject, 
                     food = get_unique(ps.trnL, subject)) %>% 
          # Add to results dataframe
          bind_rows(uniques.trnL, .)
}
```

```{r}
# Do any of these come up in all four subjects?
uniques.trnL %>% 
     group_by(food) %>% 
     count() %>% 
     filter(n > 1)
```

```{r}
# Add PSM counts
melt.protein <- psmelt(ps.protein)

uniques.trnL <- 
     melt.protein %>% 
     filter(Abundance != 0) %>% 
     select(subj, Sample, food = OTU, Abundance) %>% 
     right_join(uniques.trnL, by = c('subj', 'food')) %>% 
     arrange(subj, desc(Abundance))
```

#### 12SV5

### Menu

```{r}
# Update ID to subj to be compatible with function
samdf.menu <- as(sample_data(ps.menu), 'data.frame')
samdf.menu <- rename(samdf.menu, subj = ID)

sample_data(ps.menu) <- samdf.menu
```

```{r}
# For storing results
uniques.menu <- data.frame()

# Find unique foods for each subject
for (subject in subjects){
     uniques.menu <- 
          # Get uniques.protein
          data.frame(subj = subject, 
                     food = get_unique(ps.menu, subject)) %>% 
          # Add to results dataframe
          bind_rows(uniques.menu, .)
}
```

```{r}
# Add amount consumed (dry weight here)
melt.menu <- psmelt(ps.menu)

uniques.menu <- 
     melt.menu %>% 
     filter(Abundance != 0) %>% 
     select(subj, Sample, food = OTU, Abundance) %>% 
     right_join(uniques.menu, by = c('subj', 'food')) %>% 
     arrange(subj, desc(Abundance))
```

## Intersection

### Unique in metaproteomics, menu

```{r}
intersect.menu.protein <- 
     full_join(uniques.menu, uniques.protein,
          by = c('subj', 'food')) %>% 
     select(subj, food,
            menu_abd = Abundance.x, psm_abd = Abundance.y,
            menu_sample = Sample.x, psm_sample = Sample.y) %>% 
     arrange(subj, desc(psm_abd))
     
intersect.menu.protein %>% 
     filter(!is.na(menu_abd) & !is.na(psm_abd))
```
So overall, this is encouraging in that the detected PSMs almost always come after the food was recorded as consumed in the menu.  However, this seems only to work for PSMs that are detected in very low absolute amounts.  Can I do a manual comparison to see if names aren't matching up?

#### Manual notes

##### AK65

*Sesamum indicum*: detected in stool on 2019/09/26.  In menu, can occur from sesame oil, sesame seeds, or tahini.

```{r}
ps.menu %>% 
     subset_taxa(genus == 'Sesamum') %>% 
     subset_samples(subj == 'AK65') %>% 
     prune_samples(sample_sums(.) > 0, .) %>% 
     otu_table()
```

9/17: Garlicky Sesame Broccoli (sesame oil)
9/18: Spicy Stir-Fried Snow Peas (toasted sesame seeds), totaling 1 g dry weight
9/24: Sesame Snap Peas w/Carrots and Peppers (sesame oil, toasted sesame seeds); Sesame-Shiitake Bok Choy (sesame oil, toasted sesame seeds). Seeds totaling 1.467 g dry weight
9/27: Vietnamese Chicken Meatballs (sesame oil)

*Apium graveolens*: detected in stool on 2019/09/27

```{r}
ps.menu %>% 
     subset_taxa(species == 'Apium graveolens') %>% 
     subset_samples(subj == 'AK65') %>% 
     prune_samples(sample_sums(.) > 0, .) %>% 
     otu_table()
```

9/26: Radish, Celery & Snap Pea Salad (raw celery)

*Oreochromis niloticus* (tilapia): Interestingly, recorded only once in menu (9/23), but turns up with bimodal distribution in stool samples:

```{r}
ps.protein %>% 
     subset_samples(subj == 'AK65') %>% 
     subset_taxa(genus == 'Oreochromis') %>% 
     otu_table() %>% 
     data.frame(PSMs = .) %>% 
     rownames_to_column(var = 'sample') %>% 
     mutate(date = as.Date(gsub('AK65_', '', sample))) %>% 
     ggplot(aes(x = date, y = Oreochromis.niloticus)) +
     geom_bar(stat = 'identity') +
     geom_vline(xintercept = as.Date('2019-09-23'),
                color = 'red', alpha = 0.5, linetype = 'dashed') +
     labs(y = 'PSMs') +
     theme_bw() +
     theme(axis.title.x = element_blank())
```


### Unique in metabarcoding, menu


```{r}

```


### Unique in metabarcoding, metaproteomics