---
title: "Ordinations"
output: html_notebook
---

For this, remember that the 908 menu data has been coded in a different "style." Do I want to have a go at recoding the DFC menu correspondingly?

# R setup

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r libraries, echo=FALSE}
library(here) 
library(phyloseq) 
library(tidyverse) 
```

```{r}
# Define color palettes
subj.colors <- 
     palette.colors(n = 5, 
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Plotting themes
theme_set(theme_bw() +
               theme(
                    axis.text = element_text(size = 12),
                    axis.title.x = element_text(size = 14,
                                                face = 'bold'),
                    axis.title.y = element_text(size = 14,
                                                face = 'bold'),
                    legend.title = element_text(size = 12,
                                                face = 'bold'),
                    strip.text = element_text(size = 12,
                                              face = 'bold')
               )
)
```

# Read in data

## Metaproteomic phyloseq

```{r}
ps.protein <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'filtered',
          'ps_mp_1UP_taxa.rds') %>% # 1UP
     readRDS() 

ps.protein
```

## Menu data phyloseq

```{r}
ps.menu <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'filtered',
          'ps_menu.rds') %>% 
     readRDS()

ps.menu
```

## Metabarcoding phyloseq

```{r}
# 12SV5
ps.mb.animal <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'filtered',
          'ps_mb_12SV5.rds') %>% 
     readRDS()
     
ps.mb.animal
```

```{r}
# trnL
ps.mb.plant <- 
     here('data',
          'processed',
          'phyloseq',
          'combined', 
          'filtered',
          'ps_mb_trnL.rds') %>% 
     readRDS() 

ps.mb.plant
```

# Pre-process

## Metabarcoding phyloseq

### Remove failed samples

```{r}
min(sample_sums(ps.mb.plant)) 
min(sample_sums(ps.mb.animal))
```

```{r}
ps.mb.plant <- prune_samples(sample_sums(ps.mb.plant) > 0, ps.mb.plant)
ps.mb.plant
```

This removes 4 plant samples.

### Combine kingdoms

```{r}
# The intersection of non-zero samples
intersect(sample_names(ps.mb.plant),
          sample_names(ps.mb.animal))
```

```{r}
ps.mb <-
     ps.mb.animal %>% 
     prune_samples(sample_names(.) %in% sample_names(ps.mb.plant), .) %>% 
     merge_phyloseq(ps.mb.plant)

ps.mb
```

```{r}
rm(ps.mb.plant, ps.mb.animal)
```

## Menu phyloseq

Here, what should I plot? Aggregated menu from 1-2 d before intake (to be consistent w/downstream results?)

Why don't I just start with one day before and see how it goes.

### Subset to lag = -1

```{r}
nsamples(ps.menu)
```

```{r}
ps.menu <- 
     ps.menu %>% 
     prune_samples(sample_names(.) %in% intersect(
          sample_data(ps.mb)$delta1,
          sample_data(ps.protein)$delta1),
                   .) %>% 
     prune_taxa(taxa_sums(.) > 0, .)

ps.menu
```

# Analyze

## Ordinations

#### Metaproteomics

Is metaproteomic data compositional??
Think that it may be, because PCA on raw data looks wonky.

##### PCA

```{r}
# CLR transform
ps.protein.clr <- 
     microbiome::transform(ps.protein,
                           transform = 'clr')
```

```{r}
# PCA
pca <- prcomp(ps.protein.clr@otu_table@.Data, 
              center = TRUE, 
              scale = FALSE)

pca.df <- 
        data.frame(pca$x) %>% 
        rownames_to_column(var = 'well')

# % variance explained
eigs <- pca$sdev^2
ve.pc1 <- as.character(100*round(eigs[1] / sum(eigs), 3))
ve.pc2 <- as.character(100*round(eigs[2] / sum(eigs), 3))

# Add back sample data
samdf <- 
     data.frame(ps.protein@sam_data) %>% 
     rownames_to_column(var = 'well')

pca.df <- left_join(pca.df, samdf)

limit <- max(abs(pca.df[, c('PC1', 'PC2')])) +
          0.05*(max(abs(pca.df[, c('PC1', 'PC2')])))
```

```{r}
# Plot
mp.plot <- 
     ggplot(pca.df, aes(x = PC1, y = PC2, 
                        color = subj)) +
     geom_point(size = 3, alpha = 0.7) +
     coord_equal() +
     labs(x = paste0(' PC1 (', ve.pc1, '%)'),
          y = paste0(' PC2 (', ve.pc2, '%)')) +
     scale_color_manual(values = subj.colors) +
     xlim(-limit, limit) + ylim(-limit, limit) +
     theme(panel.grid = element_blank())

mp.plot
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '2',
            paste0(plotID, '_Metaproteomic ordination (Aitchison).pdf')),
       device = cairo_pdf,
       height = 4, width = 4)
```

```{r}
samdf <- data.frame(ps.protein@sam_data)
vegan::adonis(distance(ps.protein.clr, 
                       method = 'euclidean') ~ subj, 
              data = samdf)
```

##### PCoA on Jaccard

```{r}
ord.protein <- 
     ordinate(ps.protein,
              method = 'PCoA',
              distance = 'jaccard',
              binary = TRUE)
```

```{r}
# Raw plot, to be re-done below
plot_ordination(ps.protein,
                     ord.protein,
                     type = 'samples',
                     color = 'subj') +
     scale_color_manual(values = subj.colors) 
```


```{r}
# Customize plot 
data <- data.frame(ord.protein$vectors)
samdf.protein <- data.frame(ps.protein@sam_data)

data <- bind_cols(data, samdf.protein)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (14%)',
          y = 'PCo2 (11.9%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme(legend.title = element_blank(),
           panel.grid = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Metaproteomic ordination, taxa (Jaccard).pdf')),
       device = cairo_pdf,
       height = 4, width = 4)
```

```{r}
vegan::adonis(distance(ps.protein, 
                       method = 'jaccard',
                       binary = TRUE) ~ subj,
              data = samdf.protein)
```

#### Metabarcoding

##### PCA

```{r}
# Make updated phyloseq object
ps.mb.clr <- 
     microbiome::transform(ps.mb,
                           transform = 'clr')
```

```{r}
# PCA
pca <- prcomp(ps.mb.clr@otu_table@.Data, 
              center = TRUE, 
              scale = FALSE)

pca.df <- 
        data.frame(pca$x) %>% 
        rownames_to_column(var = 'name')

# % variance explained
eigs <- pca$sdev^2
ve.pc1 <- as.character(100*round(eigs[1] / sum(eigs), 3))
ve.pc2 <- as.character(100*round(eigs[2] / sum(eigs), 3))

# Add back sample data
samdf.mb <- 
     data.frame(ps.mb@sam_data) %>% 
     rownames_to_column(var = 'name')

pca.df <- left_join(pca.df, samdf.mb)

limit <- max(abs(pca.df[, c('PC1', 'PC2')])) +
          0.05*(max(abs(pca.df[, c('PC1', 'PC2')])))
```

```{r}
# Plot
mb.plot <- 
     ggplot(pca.df, aes(x = PC1, y = PC2, 
                        color = subj)) +
     geom_point(size = 3, alpha = 0.7) +
     coord_equal() +
     labs(x = paste0(' PC1 (', ve.pc1, '%)'),
          y = paste0(' PC2 (', ve.pc2, '%)')) +
     scale_color_manual(values = subj.colors) +
     xlim(-limit, limit) + ylim(-limit, limit) +
     theme(panel.grid = element_blank())

mb.plot
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '2',
            paste0(plotID, '_Metabarcoding ordination (Aitchison).pdf')),
       device = cairo_pdf,
       height = 4, width = 4)
```

```{r}
vegan::adonis(distance(ps.mb.clr, method = 'euclidean') ~ subj, 
              data = samdf.mb)
```

##### PCoA on Jaccard

```{r}
ord.mb <- 
     ps.mb %>% 
     ordinate(.,
              method = 'PCoA',
              distance = 'jaccard',
              binary = TRUE)
```

```{r}
plot_ordination(ps.mb,
                ord.mb,
                type = 'samples',
                color = 'subj')
```

```{r}
# Customize plot 
data <- 
     data.frame(ord.mb$vectors) %>% 
     rownames_to_column(var = 'name')

data <- left_join(data, samdf.mb)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (24.2%)', 
          y = 'PCo2 (11.2%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme(panel.grid = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Metabarcoding ordination (Jaccard).pdf')),
       device = cairo_pdf,
       height = 4, width = 4)
```

```{r}
vegan::adonis(distance(ps.mb, 
                       method = 'jaccard',
                       binary = TRUE) ~ subj,
              data = samdf.mb)
```

### Mantel tests:

#### Aitchison
```{r}
set.seed(1234)
# trnL vs plant proteins
# Subset to only sequenced samples

samples <- intersect(sample_names(ps.protein.plant),
                     sample_names(ps.mb.plant))

asvtab.mb.plant <- ps.mb.plant.clr@otu_table@.Data[samples, ]
asvtab.protein.plant <- ps.protein.plant.clr@otu_table@.Data[samples, ]

# Does this Mantel need a strata argument?
# samples.strata <- 
#      samples %>% 
#      gsub(pattern = '_.*$', 
#           replacement = '') %>% 
#      factor()

vegan::mantel(dist(asvtab.mb.plant),
              dist(asvtab.protein.plant))
              # strata = samples.strata)
```

This is surprising, esp based on the appearance of the ordination.  What about instead trying on distances between PCA-transformed points?

```{r}
set.seed(1234)
# trnL vs plant proteins
# Subset to only sequenced samples

samples.plant <- intersect(sample_names(ps.protein.plant),
                           sample_names(ps.mb.plant))

pca.mb.plant <- 
     prcomp(ps.mb.plant.clr@otu_table@.Data[samples.plant, ],
            center = TRUE, 
            scale = FALSE)

pca.protein.plant <- 
     prcomp(ps.protein.plant.clr@otu_table@.Data[samples.plant, ],
            center = TRUE,
            scale = FALSE)

# samples.strata <- 
#      samples.plant %>% 
#      gsub(pattern = '_.*$', 
#           replacement = '') %>% 
#      factor()

vegan::mantel(dist(pca.mb.plant$x[,1:2]),
              dist(pca.protein.plant$x[,1:2]))
```

```{r}
set.seed(1234)
# 12SV5 vs animal proteins
# Subset to only sequenced samples

samples.animal <- intersect(sample_names(ps.protein.animal),
                            sample_names(ps.mb.animal))

asvtab.mb.animal <- ps.mb.animal.clr@otu_table@.Data[samples, ]
asvtab.protein.animal <- ps.protein.animal.clr@otu_table@.Data[samples, ]

# samples.strata <- 
#      samples %>% 
#      gsub(pattern = '_.*$', 
#           replacement = '') %>% 
#      factor()

vegan::mantel(dist(asvtab.mb.animal),
              dist(asvtab.protein.animal))
```

```{r}
set.seed(1234)
# 12SV5 vs animal proteins
# Subset to only sequenced samples

samples.animal <- intersect(sample_names(ps.protein.animal),
                            sample_names(ps.mb.animal))

pca.mb.animal <- 
     prcomp(ps.mb.animal.clr@otu_table@.Data[samples.animal, ],
            center = TRUE, 
            scale = FALSE)

pca.protein.animal <- 
     prcomp(ps.protein.animal.clr@otu_table@.Data[samples.animal, ],
            center = TRUE,
            scale = FALSE)

vegan::mantel(dist(pca.mb.animal$x[,1:2]),
              dist(pca.protein.animal$x[,1:2]))
```


#### Jaccard

```{r}
set.seed(1234)
vegan::mantel(distance(prune_samples(samples.plant, ps.mb.plant),
                       method = 'jaccard',
                       binary = TRUE),
              distance(prune_samples(samples.plant, ps.protein.plant),
                       method = 'jaccard',
                       binary = TRUE))
```

```{r}
set.seed(1234)

vegan::mantel(dist(ord.mb.plant$vectors[samples.plant, 1:2]),
              dist(ord.protein.plant$vectors[samples.plant, 1:2])
)
```

```{r}
vegan::mantel(
     distance(
          prune_samples(samples.animal,
                        ps.mb.animal),
          method = 'jaccard',
          binary = TRUE),
     distance(
          ps.protein.animal,
          method = 'jaccard',
          binary = TRUE))
```

```{r}
set.seed(1234)

vegan::mantel(dist(ord.mb.animal$vectors[samples.animal, 1:2]),
              dist(ord.protein.animal$vectors[samples.animal, 1:2])
)
```

## Consecutive days

Here can work only with Aitchison because it's what I've selected based on results above.

### Metaproteomic
#### Plant

```{r}
dist.protein.plant <- 
     ord.protein.plant$vectors %>% 
     dist() %>% 
     as.matrix() %>% 
     data.frame() %>% 
     rownames_to_column(var = 'x') %>% 
     pivot_longer(cols = -x,
                  names_to = 'y',
                  values_to = 'distance') 

dist.protein.plant
```
```{r}
# Clean up column names
dist.protein.plant <-
     dist.protein.plant %>% 
     mutate(y = gsub(y,
                     pattern = '^X',
                     replacement = ''),
            y = gsub(y,
                     pattern = '\\.',
                     replacement = '-'))

head(dist.protein.plant)
```
```{r}
# Reorganize data types
dist.protein.plant <-
     dist.protein.plant %>% 
     mutate(subj1 = gsub(x,
                        pattern = '_.*$',
                        replacement = ''), # Extract subject
            subj2 = gsub(y,
                        pattern = '_.*$',
                        replacement = ''),
            across(.cols = c(x, y),
                   ~ gsub(.x,
                          pattern = '^.+_',
                          replacement = '')), # Remove old subject info
            across(.cols = c(x, y),
                   as.Date))   # Convert to Date type

dist.protein.plant
```
```{r}
# Prune to only intrasubject comparisons and remove redundant dates
dist.protein.plant <-
     dist.protein.plant %>% 
     filter(subj1 == subj2) %>% 
     mutate(subj = subj1) %>% 
     group_by(x, y, subj) %>% 
     mutate(first = min(x, y),
            second = max(x, y),
            delta = second - first) %>% 
     filter(delta > 0) %>% 
     ungroup() %>% 
     select(subj, first, second, delta, distance) %>% 
     distinct()

dist.protein.plant
```

```{r}
# Plot
ggplot(dist.protein.plant, aes(x = delta, 
                               y = distance,
                               group = delta,
                               by = delta)) +
     geom_boxplot()
```

```{r}
# Plot
ggplot(dist.protein.plant, aes(x = delta > 1, 
                               y = distance,
                               group = delta > 1,
                               by = delta > 1)) +
     geom_point() +
     facet_wrap(~subj)
```

#### Animal

```{r}
dist.protein.animal <- 
     data.frame(ord.protein.animal$vectors) %>% 
     dist() %>% 
     as.matrix() %>% 
     data.frame() %>% 
     rownames_to_column(var = 'x') %>% 
     pivot_longer(cols = -x,
                  names_to = 'y',
                  values_to = 'distance') %>% 
     mutate(y = gsub(y,
                     pattern = '^X',
                     replacement = ''),
            y = gsub(y,
                     pattern = '\\.',
                     replacement = '-')) %>% 
     mutate(subj1 = gsub(x,
                        pattern = '_.*$',
                        replacement = ''), # Extract subject
            subj2 = gsub(y,
                        pattern = '_.*$',
                        replacement = ''),
            across(.cols = c(x, y),
                   ~ gsub(.x,
                          pattern = '^.+_',
                          replacement = '')), # Remove old subject info
            across(.cols = c(x, y),
                   as.Date)) %>%   # Convert to Date type
     filter(subj1 == subj2) %>% 
     mutate(subj = subj1) %>% 
     group_by(x, y, subj) %>% 
     mutate(first = min(x, y),
            second = max(x, y),
            delta = second - first) %>% 
     filter(delta > 0) %>% 
     ungroup() %>% 
     select(subj, first, second, delta, distance) %>% 
     distinct()

dist.protein.animal
```
```{r}
# Plot
ggplot(dist.protein.animal, aes(x = delta > 1, 
                          y = distance,
                          group = delta > 1,
                          by = delta > 1)) +
     geom_point() +
     facet_wrap(~subj)
```

### Metabarcoding
#### Plant

```{r}
dist.mb.plant <- 
     data.frame(ord.mb.plant$vectors) %>% 
     dist() %>% 
     as.matrix() %>% 
     data.frame() %>% 
     rownames_to_column(var = 'x') %>% 
     pivot_longer(cols = -x,
                  names_to = 'y',
                  values_to = 'distance') %>% 
     mutate(y = gsub(y,
                     pattern = '^X',
                     replacement = ''),
            y = gsub(y,
                     pattern = '\\.',
                     replacement = '-')) %>% 
     mutate(subj1 = gsub(x,
                        pattern = '_.*$',
                        replacement = ''), # Extract subject
            subj2 = gsub(y,
                        pattern = '_.*$',
                        replacement = ''),
            across(.cols = c(x, y),
                   ~ gsub(.x,
                          pattern = '^.+_',
                          replacement = '')), # Remove old subject info
            across(.cols = c(x, y),
                   as.Date)) %>%   # Convert to Date type
     filter(subj1 == subj2) %>% 
     mutate(subj = subj1) %>% 
     group_by(x, y, subj) %>% 
     mutate(first = min(x, y),
            second = max(x, y),
            delta = second - first) %>% 
     filter(delta > 0) %>% 
     ungroup() %>% 
     select(subj, first, second, delta, distance) %>% 
     distinct()

dist.mb.plant
```
```{r}
# Plot
ggplot(dist.mb.plant, aes(x = delta > 1, 
                          y = distance,
                          group = delta > 1,
                          by = delta > 1)) +
     geom_point() +
     facet_wrap(~subj)
```

#### Animal

```{r}
dist.mb.animal <- 
     data.frame(ord.mb.animal$vectors) %>% 
     dist() %>% 
     as.matrix() %>% 
     data.frame() %>% 
     rownames_to_column(var = 'x') %>% 
     pivot_longer(cols = -x,
                  names_to = 'y',
                  values_to = 'distance') %>% 
     mutate(y = gsub(y,
                     pattern = '^X',
                     replacement = ''),
            y = gsub(y,
                     pattern = '\\.',
                     replacement = '-')) %>% 
     mutate(subj1 = gsub(x,
                        pattern = '_.*$',
                        replacement = ''), # Extract subject
            subj2 = gsub(y,
                        pattern = '_.*$',
                        replacement = ''),
            across(.cols = c(x, y),
                   ~ gsub(.x,
                          pattern = '^.+_',
                          replacement = '')), # Remove old subject info
            across(.cols = c(x, y),
                   as.Date)) %>%   # Convert to Date type
     filter(subj1 == subj2) %>% 
     mutate(subj = subj1) %>% 
     group_by(x, y, subj) %>% 
     mutate(first = min(x, y),
            second = max(x, y),
            delta = second - first) %>% 
     filter(delta > 0) %>% 
     ungroup() %>% 
     select(subj, first, second, delta, distance) %>% 
     distinct()

dist.mb.animal
```

```{r}
# Plot
ggplot(dist.mb.animal, aes(x = delta > 1, 
                          y = distance,
                          group = delta > 1,
                          by = delta > 1)) +
     geom_point() +
     facet_wrap(~subj)
```

### Menu

The menus are currently in different formats:
- DFC is absolute amount of food consumed (gram weight)
- Healthy donor is instances of food intake on a given day.

Because these can't be directly compared, I think best to just binarize for now (do this as PCoA on Jaccard).

A workaround strategy would be to label foods as "high", "med", "low" intake.  This could be done by estimation for Healthy Donor and programmatically for DFC.

#### Jaccard

```{r}
ord.menu <- 
     ordinate(ps.menu.plant,
              method = 'PCoA',
              distance = 'jaccard',
              binary = TRUE)
```

```{r}
p <-  
     plot_ordination(ps.menu.plant,
                     ord.menu,
                     type = 'samples',
                     color = 'subj')
p
```

```{r}
subj.colors <- 
     palette.colors(n = 5,
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Customize plot 
data <- data.frame(ord.menu$vectors)
samdf.menu <- data.frame(ps.menu.plant@sam_data)

data <- bind_cols(data, samdf.menu)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (17.3%)',
          y = 'PCo2 (12.5%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme_bw() +
     theme(legend.title = element_blank()) +
     theme(axis.line = element_line(size = 1,
                                    color = 'gray80'),
           axis.text = element_text(size = 12,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.title = element_text(size = 14,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.ticks = element_line(size = 1, 
                                     color = 'gray80'),
           legend.text = element_text(size = 10,
                                      face = 'bold',
                                      color = 'gray40'),
           panel.border = element_blank(),
           panel.grid.major = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Menu ordination (Jaccard).pdf')))
```

```{r}
vegan::adonis(distance(ps.menu.plant, 
                       method = 'jaccard',
                       binary = TRUE) ~ subj,
              data = samdf.menu)
```
