---
title: "Kleiner lab database testing"
output:
  html_document:
    df_print: paged
---

First priority: Are there any obvious species missing?
False positives and false negatives

Here we are evaluating the preliminary data shared by the Kleiner lab at NCSU to determine if their metaproteomic database should be adjusted (e.g. filtering out homologs to human proteins, other ideas?) before continuing with analysis of the DFC samples.

# R setup

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r libraries, echo=FALSE}
library(here) 
library(phyloseq) 
library(readxl) # For parsing Excel files
library(tidyverse) 
```

# Read in files

## Current reference database

```{r eval = FALSE, echo = FALSE}
# Read in the first sheet of the file using read_excel function
db <- read_excel(here('data', 'processed', 'DietaryDB_ForDavidLab.xlsx'), 
                 sheet = 1, 
                 n_max = 547) # Exclude annotations at end of file
head(db)
```
```{r eval = FALSE, echo = FALSE}
# Manual updates
# Specify scientific name for tilapia
db$scientific_name[db$scientific_name == 'Tilapia'] <- 'Oreochromis niloticus'
# Correct misspelling for mallard duck
db$scientific_name[db$scientific_name == 'Anas platyrhynchose'] <- 'Anas platyrhynchos'
# Switch var. to subsp. for durum
db$scientific_name[db$scientific_name == 'Triticum turgidum var. durum'] <- 'Triticum turgidum subsp. durum'
# Correct spelling of water buffalo
db$scientific_name[db$scientific_name == 'Bubalis bubalis'] <- 'Bubalus bubalis'
# Think something weird about formatting of "x" in Musa x paradisiaca, not being recognized
db$scientific_name[db$common_name == 'plantain'] <- 'Musa x paradisiaca'
# Remove zante currant, which is redundant with V. vinifera
db <- filter(db, common_name != 'zante currant')
``` 
## Participant metaproteomic data

### Combine files

```{r eval = FALSE, echo = FALSE}
# List files
fs <- list.files(here('data', 'raw',
                     'Proteins_IndividualResultFiles_RealisticFoodsWithMicrobiota'),
                  pattern = ".xlsx", full.names = T)

# Read and synchronize names
dfs <- 
     lapply(fs, read_excel) %>% 
     # Rename "Found in sample" column so it's the same for each sample
     lapply(., 
            function(x){
                 # Update name
                 names(x)[grep('Found in Sample: *', names(x))] <- 'Found in Sample'
                 # Return original object
                 x
                 }
            )

# Bind together
names(dfs) <- basename(fs)
proteins.df <- bind_rows(dfs, .id = 'id')
rm(fs, dfs)
```

### Clean
```{r eval = FALSE, echo = FALSE}
proteins.df <- 
     proteins.df %>% 
     # Clean up ID column
     separate(col = 'id', into = c('id', 'subj', 'date'),
                        sep = '_', remove = TRUE, extra = 'drop') %>% 
     # Convert date to Date type
     mutate(date = as.Date(date, format = '%d%b%y'))
```

```{r eval = FALSE, echo = FALSE}
head(proteins.df)
```
```{r eval = FALSE, echo = FALSE}
dim(proteins.df)
```

### Filter 

```{r eval = FALSE, echo = FALSE}
# Filter to only food-derived proteins (this removes majority)
proteins.df <- 
     proteins.df %>% 
     filter(!grepl('Human_*', Accession)) %>% # Remove human proteins
     filter(!grepl('Microbiota_*', Accession)) # Remove microbiota proteins

dim(proteins.df)
```

```{r eval = FALSE, echo = FALSE}
# Remove proteins labeled as not found in sample
# Very low abundance (though non-zero counts), only one from wheat
proteins.df <- filter(proteins.df, `Found in Sample` != 'Not Found')
dim(proteins.df)
```

### Relabel with food species

Using a combination of OS (embedded in Description column) and prefix assigned in database.

```{r eval = FALSE, echo = FALSE}
head(proteins.df$Description)
cat('\n')
head(proteins.df$Accession)
```

```{r eval = FALSE, echo = FALSE}
# Separate prefix into its own column

# Helper function for use inside mutate
helper <- function(str, ex){
     substring <- str_match(str, ex)
     substring[, 2] # Second column has capture group
}

# Extract prefix before '_'
proteins.df <- mutate(proteins.df, prefix = helper(Accession, '(\\w+)_.*'))
```

```{r eval = FALSE, echo = FALSE}
# How many missing entries?
sum(is.na(proteins.df$prefix))
```

```{r eval = FALSE, echo = FALSE}
# Extract OS from Description column
proteins.df <- mutate(proteins.df, OS = helper(Description, 'OS=(.*)\\sOX='))
```

```{r eval = FALSE, echo = FALSE}
filter(proteins.df, is.na(prefix)) %>% pull(OS) %>% unique()
```

In some cases, the OS is more specific than it should be to match back to database. 
```{r eval = FALSE, echo = FALSE}
# Manual correction to match database (V.radiata, M. piperita, O. sativa, B. vulgaris)

proteins.df$OS[proteins.df$OS == 'Vigna radiata var. radiata'] <- 'Vigna radiata'
proteins.df$OS[proteins.df$OS == 'Mentha piperita'] <- 'Mentha x piperita'

# P. nigrum prefix labeled as Pne, should be Pni by database

proteins.df$prefix[proteins.df$prefix == 'Pne'] <- 'Pni'
```

```{r eval = FALSE, echo = FALSE}
# Label with prefix unless unavailable; otherwise label by OS

# Join by prefix
join.prefix <- 
     proteins.df %>% 
     # Remove rows without a prefix label
     filter(!is.na(prefix)) %>% 
     # Remove any duplicated prefixes based on initial results
     filter(!(prefix %in% c('Pgr', 'Shi', 'Scer', 'Sso', 'Vvi'))) %>%  
     left_join(select(db, scientific_name:category, `PreFix Used`), 
               by = c('prefix' = 'PreFix Used'))

# How many should there be?
proteins.df %>% 
     # Get missed rows in last join
     filter(!is.na(prefix)) %>% 
     # Remove any duplicated prefixes based on initial results
     filter(!(prefix %in% c('Pgr', 'Shi', 'Scer', 'Sso', 'Vvi'))) %>% 
     dim

# How many are there?
dim(join.prefix)
```

On first pass through, these dimensions didn't check out-- turns out there are some prefixes with duplicated entries. Only Pgr and Shi come up here

Pgr: Assigned to both Prunus grayana (japanese bird cherry) and Punica granatum (pomegranate)
Shi: Assigned to both Salvia hispanica (chia) and Scorzonera hispanica (salsify)
Scer: Saccharomyces cerevisiae (yeast) and Secale cereale (rye)
Sso: Salsola soda (saltwort) and Smallanthus sonchifolius (yacon)
Vvi: Vaccinium vitis-idaea (lingonberry) and Vitis vinifera (grape)

```{r eval = FALSE, echo = FALSE}
# Now, find those entries not joined by prefix, and join by OS instead
join.os <- 
     proteins.df %>% 
     # Get missed rows in last join
     filter(is.na(prefix) | prefix %in% c('Pgr', 'Shi', 'Scer', 
                                          'Sso', 'Vvi')) %>% 
     left_join(select(db, scientific_name:category),
               by = c('OS' = 'scientific_name')) %>% 
     rename(scientific_name = OS)

# Check dimensions are appropriate
cat('Combined dimensions of OS and prefix entries:', dim(join.os)[1] + dim(join.prefix)[1], '\n')
cat('Dimensions of input:', dim(proteins.df)[1])
```

```{r eval = FALSE, echo = FALSE}
# Bind together OS- and prefix-based joins to return to the full dataset

# Drop prefix columns 
join.prefix <- select(join.prefix, -c(prefix, OS))
join.os <- select(join.os, -prefix)

# Check all columns the same
all(names(join.prefix) == names(join.os))

# Join
proteins.df <- bind_rows(join.os, join.prefix)
dim(proteins.df) # How many entries?
any(is.na(proteins.df$scientific_name)) # Any missing entries?
```

### Format as phyloseq object

#### Sample data

```{r eval = FALSE, echo = FALSE}
samdf <-
     proteins.df %>%
     mutate(sample = paste(subj, date, sep = '_')) %>%
     select(subj, date, sample) %>%
     distinct() %>% # Remove duplicated rows
     column_to_rownames(var = 'sample')
```

#### OTU table

```{r eval = FALSE, echo = FALSE}
psm.counts.wide <-
     proteins.df %>%
     mutate(sample = paste(subj, date, sep = '_')) %>% # Create unique label
     # Need to group & summarize, because may be multiple peptides/food
     group_by(sample, scientific_name) %>%
     summarize(abundance = sum(`# PSMs`)) %>%
     pivot_wider(names_from = scientific_name,
                 values_from = abundance, # Total # PSMs
                 values_fill = 0) %>% # If no entry, log as 0
     column_to_rownames(var = 'sample')
```

#### Taxonomy table

Regardless of whether I go on to use taxids as names, I do need to query to build the taxonomy table for the phyloseq object.
```{r eval = FALSE, echo = FALSE}
binomial.only <-
     proteins.df %>%
     select(scientific_name) %>%
     distinct()

taxids <- taxa::lookup_tax_data(binomial.only,
                                type = 'taxon_name',
                                column = 'scientific_name',
                                database = 'ncbi')
```

What wasn't found?
```{r eval = FALSE, echo = FALSE}
result <- taxids$data$query_data
result$scientific_name[result$taxon_id == 'unknown']
```

Get taxonomy
```{r eval = FALSE, echo = FALSE}
taxtab.protein <-
     taxa::taxonomy_table(taxids,
                          use_ranks = c('superkingdom', 'kingdom', 'phylum', 
                                        'class', 'superorder', 
                                        'order', 'superfamily', 
                                        'family', 'genus', 'species', 
                                        'subspecies', 'varietas'),
                          add_id_col = TRUE)
```

Note that not all taxids are terminally listed here:
```{r eval = FALSE, echo = FALSE}
dim(taxtab.protein)[1]
length(unique(taxids$data$query_data$taxon_id))
```

This is because some are internal nodes. Manually add their taxonomy too:

```{r eval = FALSE, echo = FALSE}
add <- setdiff(unique(taxids$data$query_data$taxon_id), taxtab.protein$taxon_id)

# Manually inspect
# taxids$data$query_data %>%
#      filter(taxon_id %in% add) %>% View()

# Write full table, subset these columns out
# write_csv(taxtab.protein,
#           here('data', 'processed',
#                '20210208_Internal taxonomy table nodes.csv'))

add.rows <-
     here('data', 'processed', 
          '20210208_Internal taxonomy table nodes.csv') %>%
     read_csv(col_types = cols(.default = 'c'))
```

```{r eval = FALSE, echo = FALSE}
# Bind together
taxtab.protein <-
        taxtab.protein %>%
        bind_rows(add.rows) %>%
        as.data.frame() # This is required in order for lowest level step to work-- so weird-- the code below doesn't seem to work on a tibble
```

Add lowest level name as row name

```{r eval = FALSE, echo = FALSE}
# This gets the right-most, non-NA values
lowest.index <- max.col(!is.na(taxtab.protein), 'last')

# Make row-column pairs to pull and add to taxonomy
taxtab.protein$lowest.level <- taxtab.protein[cbind(seq_along(lowest.index),
                                            lowest.index)]

# Now drop taxid, and convert terminal name to row name
taxtab.protein <-
        taxtab.protein %>%
        select(-taxon_id) %>%
        column_to_rownames(var = 'lowest.level')
```

```{r eval = FALSE, echo = FALSE}
# Check everything matches
setdiff(names(psm.counts.wide), row.names(taxtab.protein))
setdiff(row.names(taxtab.protein), names(psm.counts.wide))
```

```{r eval = FALSE, echo = FALSE}
# Make phyloseq object
ps.protein <- phyloseq(otu_table(psm.counts.wide, taxa_are_rows = FALSE),
                       sample_data(samdf),
                       tax_table(as.matrix(taxtab.protein)))

ps.protein

# saveRDS(ps.protein, here('data', 'processed', 'phyloseq', '20210212_ps.rds'))
```

## Metaproteomic phyloseq

```{r}
ps.protein <- readRDS(here('data', 'processed', 'phyloseq',
                           '20210212_ps_mp.rds'))
ps.protein
```

## DFC menu data phyloseq

```{r}
ps.menu <- readRDS(here('data', 'processed', 'phyloseq',
                        '20210215_ps_menu.rds'))
ps.menu
```

## Metabarcoding phyloseqs

### trnL

```{r}
ps.trnL <- readRDS(here('data', 'processed', 'phyloseq',
                        '20200225_ps_trnL.rds'))

ps.trnL
```

```{r}
# Rename samples by subject_date for compatibility
sample_names(ps.trnL) <- paste(sample_data(ps.trnL)$subject,
                               sample_data(ps.trnL)$date, sep = '_')
```

### Filtering

```{r}
# This experiment contained PCRs amplified with an annealing temp of 55 or 63C.  63C gives fewer accessory bands, and also yields more reads through current pipeline, so subset to only these samples.
ps.trnL <- 
     subset_samples(ps.trnL, anneal_t == '63') %>% 
     prune_taxa(taxa_sums(.) > 0, .) %>% 
     # Remove SVs not identified to a food
     subset_taxa(!is.na(superkingdom))

ps.trnL
```

### 12SV5

```{r}
ps.12SV5 <- readRDS(here('data', 'processed', 'phyloseq',
                         '20201014_ps_12SV5.rds'))

ps.12SV5
```

# Exploratory comparison

## Per-sample details

Overall view:
```{r echo = FALSE}
# How many food taxa consumed daily (menu)?
melt.menu <- psmelt(ps.menu)
counts.menu <- 
     melt.menu %>% 
     filter(Abundance > 0) %>% 
     group_by(ID, date) %>% 
     count(name = 'menu_taxa')
```

```{r echo = FALSE}
# How many food taxa detected daily (metaproteomics)?
melt.protein <- psmelt(ps.protein)
counts.protein <- 
     melt.protein %>% 
     filter(Abundance > 0) %>% 
     group_by(subj, date) %>% 
     count(name = 'protein_taxa')
```

```{r}
# Combine
counts <- left_join(counts.menu, counts.protein,
                    by = c('ID' = 'subj', 'date'))

# Long version for plotting
counts.long <- pivot_longer(counts, 
                            cols = ends_with('taxa'),
                            names_to = 'dataset',
                            values_to = 'value')

# Update names for plotting
counts.long$dataset <- factor(counts.long$dataset, 
                              levels = c('menu_taxa', 'protein_taxa'), 
                              labels = c('Recorded menu', 'Metaproteomics'))

head(counts)
```
```{r}
ggplot(counts.long, aes(x = dataset, y = value)) +
     geom_boxplot() +
     labs(title = 'Number of food taxa identified by source',
          y = 'Number of taxa') +
     theme_bw() +
     theme(axis.title.x = element_blank())
```

```{r echo = FALSE}
t.test(counts$menu_taxa, counts$protein_taxa)
```

By subject:

```{r echo = FALSE}
ggplot(counts.long, aes(x = ID, y = value)) +
     geom_boxplot() +
     facet_wrap(~ dataset) + 
     labs(y = 'Number of taxa') +
     theme_bw() +
     theme(axis.title.x = element_blank())
```
By subject and day: 

```{r echo = FALSE}
ggplot(counts.long, aes(x = date, y = value)) +
     geom_point(aes(color = dataset)) +
     facet_wrap(~ ID, nrow = 2, scales = 'free_x') + 
     labs(x = 'Date', y = 'Number of taxa') +
     theme_bw() +
     theme(axis.title.x = element_blank(),
           legend.title = element_blank(),
           legend.position = 'bottom')
```

## Metaproteomics x menu

### Overall dataset

```{r}
taxtab.protein <- tax_table(ps.protein)@.Data
taxtab.menu <- tax_table(ps.menu)@.Data
```

What species are shared between metaproteomic and menu datasets (regardless of menu date?)
```{r}
intersect(row.names(taxtab.protein), row.names(taxtab.menu))
```

What species are in metaproteomic dataset that are never recorded in menu data (on any day?)

This comparison is a bit tricky because some food taxa names aren't fully specified in our transcription of the menu.  Examples:
* 

```{r}
setdiff(row.names(taxtab.protein), row.names(taxtab.menu))
```

### Pairing with 1-2 days prior intake

For this broadest level comparison, let's look only at the day prior to sampling.  

```{r echo = FALSE}
samdf.protein <- 
     sample_data(ps.protein) %>% 
     as('data.frame') %>% 
     rownames_to_column(var = 'row')

# Label each stool sample with a delta
for (delta in 1:7){
     varname <- paste0('delta', delta)
     samdf.protein <- mutate(samdf.protein, 
                             !!varname := paste(subj, date - delta, 
                                                sep = '_'))
}

# Replace in phyloseq object
sample_data(ps.protein) <- column_to_rownames(samdf.protein, var = 'row')

# Get menu sample names that are 1 day prior to each stool sample
day.before <- intersect(samdf.protein$delta1, sample_names(ps.menu))
```

How many food species recorded in menu (day prior to sample)?

```{r echo = FALSE}
prune_samples(day.before, ps.menu) %>% # Select only day before samples
     prune_taxa(taxa_sums(.) > 0, .) %>% # Remove taxa no longer detected
     ntaxa()
```

How many food species detected with metaproteomics?

```{r echo = FALSE}
subset_samples(ps.protein, delta1 %in% day.before) %>% # 
     prune_taxa(taxa_sums(.) > 0, .) %>% # Remove taxa no longer detected
     ntaxa()
```

Overlap between the two?

```{r}
taxa.protein <- 
     ps.protein %>% 
     subset_samples(delta1 %in% day.before) %>%
     prune_taxa(taxa_sums(.) > 0, .) %>%
     taxa_names()

taxa.menu <- 
     ps.menu %>% 
     prune_samples(day.before, .) %>% 
     prune_taxa(taxa_sums(.) > 0, .) %>%
     taxa_names()

intersect(taxa.protein, taxa.menu)
```

Species found in menu, not by metaproteomics

```{r}
setdiff(taxa.menu, taxa.protein)
```

Species found by metaproteomics, not in menu

```{r}
setdiff(taxa.protein, taxa.menu)
```

## Effect of comparison day

Are we looking at the right time period?  Is a 24-hour period too recent? 

```{r echo = FALSE}
# Make dataframe for storing results
metrics <- data.frame(delta = NULL,
                      subject = NULL, 
                      tp = NULL,
                      fp = NULL,
                      fn = NULL)

# Initialize variables to iterate over
subjects <- unique(samdf.protein$subj) # Sequenced subjects
deltas <- # Days delta from menu
     samdf.protein %>% 
     select(starts_with('delta')) %>% 
     names()
```

```{r echo = FALSE}
for (subject in subjects){
     for (delta in deltas){
          # Rename each metaproteomic sample with its updated lag day
          sample_names(ps.protein) <- sample_data(ps.protein)[[delta]]
          
          # Extract OTU tables
          asvtab.protein <- otu_table(ps.protein)@.Data
          asvtab.menu <- otu_table(ps.menu)@.Data
          
          # Subset to rows corresponding to subject of interest
          subset_subject <- function(x, subject){
                                      x[grep(pattern = subject, 
                                             row.names(x)), ]}
                                 
          asvtab.protein <- subset_subject(asvtab.protein, subject)
          asvtab.menu <- subset_subject(asvtab.menu, subject)
          
          # Subset to only overlapping samples
          # Find if any samples don't have accompanying diet data;
          # expect this to happen some of the time, especially early in stay 
          
          # Get shared samples
          shared <- intersect(row.names(asvtab.protein), 
                              row.names(asvtab.menu))

          # For each paired sample
          for (i in seq_along(shared)){
               taxa.protein <- 
                    # Subset to shared samples and pull non-zero columns
                    which(asvtab.protein[shared[i], ] > 0) %>% 
                    names() # Get their names
               
               taxa.menu <- 
                    which(asvtab.menu[shared[i], ] > 0) %>% 
                    names() # Get their names
               
               tp = intersect(taxa.protein, taxa.menu)
               fp = setdiff(taxa.protein, taxa.menu)
               fn = setdiff(taxa.menu, taxa.protein)
               
               # Add values to metrics
               # Overall
               metrics <- bind_rows(metrics,
                                    data.frame(delta = delta,
                                               subject = subject,
                                               tp = length(tp),
                                               fp = length(fp),
                                               fn = length(fn)))
          }
     }
}
```

```{r echo = FALSE}
# Clean up for plotting
metrics <- mutate(metrics, delta = factor(gsub('delta', '', delta),
                                          levels = c(1, 2, 3, 4, 5, 6, 7)))

metrics.long <- pivot_longer(metrics, 
                             cols = tp:fn,
                             names_to = 'category',
                             values_to = 'count')

head(metrics)
```

```{r echo = FALSE}
# True positive
metrics.long %>% 
     filter(category == 'tp') %>% 
     ggplot(aes(x = delta, y = count)) +
     geom_boxplot() +
     facet_wrap(~ subject) +
     labs(title = 'True positives, by subject and lag day to menu') +
     theme_bw()
```

```{r echo = FALSE}
# False positive
metrics.long %>% 
     filter(category == 'fp') %>% 
     ggplot(aes(x = delta, y = count)) +
     geom_boxplot() +
     facet_wrap(~ subject) +
     labs(title = 'False positives, by subject and lag day to menu') +
     theme_bw()
```

```{r echo = FALSE}
# False negative
metrics.long %>% 
     filter(category == 'fn') %>% 
     ggplot(aes(x = delta, y = count)) +
     geom_boxplot() +
     facet_wrap(~ subject) +
     labs(title = 'False negatives, by subject and lag day to menu') +
     theme_bw()
```

## Effect of merging day

Are we looking at the right time period? Is a 24-hour interval too short?
