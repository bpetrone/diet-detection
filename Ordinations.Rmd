---
title: "Ordinations"
output: html_notebook
---

# R setup

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r libraries, echo=FALSE}
library(here) 
library(phyloseq) 
library(tidyverse) 
```

# Read in data

## Shared samples

```{r}
# Read in and name comparably to phyloseqs (SUBJ_DATE)
samples <- 
     here('data', 'metadata', '20200723_MTA DFC samples shared.csv') %>% 
     read_csv() %>% 
     mutate(sample.date = as.Date(sample.date, format = '%m/%d/%y'),
            name = paste(subj, sample.date, sep = '_')) %>%
     pull(name)
               
samples %>% sort()
```

## Metaproteomic phyloseq

```{r}
ps.protein <- readRDS(here('data', 'processed', 'phyloseq',
                           # '20210408_ps_mp.rds')) # 1PUP analysis
                           # '20210912_ps_mp.rds')) # 1UP analysis
                           '20211102_ps_mp_joint.rds')) #1UP w/908 (1PUP)
ps.protein
```

## DFC menu data phyloseq

```{r}
ps.menu <- readRDS(here('data', 'processed', 'phyloseq',
                        '20210220_ps_menu.rds'))
ps.menu
```

## Metabarcoding phyloseq

```{r}
# DFC: combined 12SV5 and trnL
# 908: currently trnL only
ps.mb <- 
     readRDS(here('data', 
                  'processed', 
                  'phyloseq',
                  'cleaned',
                  'WORKING_ps_mb.rds'))
     
ps.mb
```

```{r}
# Filter to only the samples under consideration here
# (Those in shared sample sheet, plus 908)
ps.mb <- 
     ps.mb %>% 
     prune_samples(sample_names(.) %in% samples | grepl('908', sample_names(.)),
                   .) %>% 
     prune_taxa(taxa_sums(.) > 0, .)

ps.mb
```

# Pre-process

## Metaproteomic phyloseq

```{r}
# Impose >= 5 PSM/taxon filter
asvtab.protein <- otu_table(ps.protein)@.Data
sum(asvtab.protein)

asvtab.protein[asvtab.protein < 5] <- 0
sum(asvtab.protein)

# Replace in phyloseq object
otu_table(ps.protein) <- otu_table(asvtab.protein,
                                   taxa_are_rows = FALSE)
```

## Metabarcoding phyloseq

```{r}
# Impose >= 5 count/taxon filter
asvtab.mb <- otu_table(ps.mb)@.Data
sum(asvtab.mb)

asvtab.mb[asvtab.mb < 5] <- 0
sum(asvtab.mb)

# Replace in phyloseq object
otu_table(ps.mb) <- otu_table(asvtab.mb,
                                   taxa_are_rows = FALSE)
```

### Separate by kingdom

Need to think about how to transform data when doing a combined ordination on plant and animals (if this is even possible)???

For now I'm not certain, so splitting.
```{r}
nsamples(ps.mb)
```

```{r}
ps.mb.plant <- 
     ps.mb %>% 
     subset_taxa(kingdom == 'Viridiplantae') %>% 
     prune_samples(sample_sums(.) > 0, .)
ps.mb.plant
```

```{r}
ps.mb.animal <- 
     ps.mb %>% 
     subset_taxa(kingdom == 'Metazoa') %>% 
     prune_samples(sample_sums(.) > 0, .)
ps.mb.animal
```

# Analyze

## Ordinations

### Metaproteomics

Is metaproteomic data compositional??
Think that it may be, because PCA on raw data looks wonky.

#### PCA

```{r}
# CLR transform
asvtab.protein <- ps.protein@otu_table@.Data 

# asvtab[asvtab < 20] = 0
asvtab.protein.clr <- driver::clr(asvtab.protein + 1) # pseudocount = 1

# Replace names, but remember these aren't interpretable as strict ASVs any longer
colnames(asvtab.protein.clr) <- colnames(asvtab.protein)

# Make updated phyloseq object
ps.protein.clr <- phyloseq(otu_table(asvtab.protein.clr, taxa_are_rows = FALSE),
                   sample_data(sample_data(ps.protein)),
                   tax_table(tax_table(ps.protein)))
```

```{r}
# Plant only
# CLR transform
asvtab.protein.plant <- 
     ps.protein %>% 
     subset_taxa(kingdom == 'Viridiplantae') %>% 
     otu_table(.) 

# asvtab[asvtab < 20] = 0
asvtab.protein.plant.clr <- 
     driver::clr(asvtab.protein.plant@.Data + 1) # pseudocount = 1

# Replace names, but remember these aren't interpretable as strict ASVs any longer
colnames(asvtab.protein.plant.clr) <- colnames(asvtab.protein.plant)

# Make updated phyloseq object
ps.protein.plant.clr <- 
     phyloseq(otu_table(asvtab.protein.plant.clr, taxa_are_rows = FALSE),
                   sample_data(sample_data(ps.protein)),
                   tax_table(tax_table(ps.protein)))
```

```{r}
# PCA
# pca <- prcomp(asvtab.protein.clr, center = TRUE, scale = FALSE)
pca <- prcomp(asvtab.protein.plant.clr, center = TRUE, scale = FALSE)

pca.df <- 
        data.frame(pca$x) %>% 
        rownames_to_column(var = 'well')

# % variance explained
eigs <- pca$sdev^2
ve.pc1 <- as.character(100*round(eigs[1] / sum(eigs), 3))
ve.pc2 <- as.character(100*round(eigs[2] / sum(eigs), 3))

# Add back sample data
samdf <- 
     data.frame(ps.protein@sam_data) %>% 
     rownames_to_column(var = 'well')

pca.df <- left_join(pca.df, samdf)

limit <- max(abs(pca.df[, c('PC1', 'PC2')])) +
          0.05*(max(abs(pca.df[, c('PC1', 'PC2')])))
```

```{r}
# Define color palettes
subj.colors <- 
     palette.colors(n = 5, 
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Plot
pca.plot <- 
     ggplot(pca.df, aes(x = PC1, y = PC2, 
                        color = subj)) +
     geom_point(size = 3, alpha = 0.7) +
     coord_equal() +
     labs(x = paste0(' PC1 (', ve.pc1, '%)'),
          y = paste0(' PC2 (', ve.pc2, '%)')) +
     scale_color_manual(values = subj.colors) +
     xlim(-limit, limit) + ylim(-limit, limit) +
     theme_classic() +
     theme(axis.line = element_line(size = 1, color = 'gray'),
           axis.ticks = element_line(color = 'gray'),
           axis.title = element_text(size = 14, face = 'bold', color = 'gray'),
           axis.text = element_blank(),
           # plot.title = element_text(size = 14, face = 'bold'),
           # legend.position = 'None',
           legend.background = element_blank(),
           legend.title = element_blank(),
           legend.text = element_text(size = 10),
           legend.position = 'bottom')

pca.plot
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '2',
            paste0(plotID, '_Plant metaproteomic ordination (Aitchison).pdf')),
       height = 5, width = 5)
```

```{r}
samdf <- data.frame(ps.protein.plant.clr@sam_data)
vegan::adonis(distance(ps.protein.plant.clr, method = 'euclidean') ~ subj, 
              data = samdf)
```

#### PCoA on distances

```{r}
# Try with plant only
ps.protein.plant <- 
     subset_taxa(ps.protein, kingdom == 'Viridiplantae')
```

```{r}
# Relative abundances
ps.protein <- 
     transform_sample_counts(ps.protein,
                             function(x){x/sum(x)})
```

```{r}
ord.protein <- 
     ordinate(ps.protein,
              method = 'PCoA',
              # distance = 'jaccard',
              # binary = TRUE)
              distance = 'bray')

# ord.protein <- 
#      ordinate(ps.protein.plant,
#               method = 'PCoA',
#               # distance = 'jaccard',
#               # binary = TRUE)
#               distance = 'bray')
```

```{r}
p <-  
     plot_ordination(ps.protein,
                     ord.protein,
                     type = 'samples',
                     color = 'subj')
p
```

```{r}
subj.colors <- 
     palette.colors(n = 5,
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Customize plot 
data <- data.frame(ord.protein$vectors)
samdf.protein <- data.frame(ps.protein@sam_data)

data <- bind_cols(data, samdf.protein)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (44.0%)',
          y = 'PCo2 (13.2%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme_bw() +
     theme(legend.title = element_blank()) +
     theme(axis.text = element_text(size = 12,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.title = element_text(size = 14,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.ticks = element_line(size = 1, 
                                     color = 'gray80'),
           legend.text = element_text(size = 10,
                                      face = 'bold',
                                      color = 'gray40'),
           panel.border = element_rect(size = 3,
                                       color = 'gray80'),
           panel.grid.major = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Metaproteomic ordination (Bray-Curtis).pdf')))
```

```{r}
vegan::adonis(distance(ps.protein, method = 'bray') ~ subj,
              data = samdf.protein)
```

### Metabarcoding

#### PCA

```{r}
# CLR transform
asvtab.mb.plant <- ps.mb.plant@otu_table@.Data 

# asvtab[asvtab < 20] = 0
asvtab.mb.plant.clr <- driver::clr(asvtab.mb.plant + 1) # pseudocount = 1

# Replace names, but remember these aren't interpretable as strict ASVs any longer
colnames(asvtab.mb.plant.clr) <- colnames(asvtab.mb.plant)

# Make updated phyloseq object
ps.mb.plant.clr <- phyloseq(otu_table(asvtab.mb.plant.clr, 
                                      taxa_are_rows = FALSE),
                   sample_data(sample_data(ps.mb.plant)),
                   tax_table(tax_table(ps.mb.plant)))
```


```{r}
# PCA
pca <- prcomp(asvtab.mb.plant.clr, center = TRUE, scale = FALSE)

pca.df <- 
        data.frame(pca$x) %>% 
        rownames_to_column(var = 'name')

# % variance explained
eigs <- pca$sdev^2
ve.pc1 <- as.character(100*round(eigs[1] / sum(eigs), 3))
ve.pc2 <- as.character(100*round(eigs[2] / sum(eigs), 3))

# Add back sample data
samdf <- 
     data.frame(ps.mb.plant@sam_data) %>% 
     rownames_to_column(var = 'name')

pca.df <- left_join(pca.df, samdf)

limit <- max(abs(pca.df[, c('PC1', 'PC2')])) +
          0.05*(max(abs(pca.df[, c('PC1', 'PC2')])))
```

```{r}
# Define color palettes
subj.colors <- 
     palette.colors(n = 5, 
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Plot
pca.plot <- 
     ggplot(pca.df, aes(x = PC1, y = PC2, 
                        color = subj)) +
     geom_point(size = 3, alpha = 0.7) +
     coord_equal() +
     labs(x = paste0(' PC1 (', ve.pc1, '%)'),
          y = paste0(' PC2 (', ve.pc2, '%)')) +
     scale_color_manual(values = subj.colors) +
     xlim(-limit, limit) + ylim(-limit, limit) +
     theme_classic() +
     theme(axis.line = element_line(size = 1, color = 'gray'),
           axis.ticks = element_line(color = 'gray'),
           axis.title = element_text(size = 14, face = 'bold', color = 'gray'),
           axis.text = element_blank(),
           # plot.title = element_text(size = 14, face = 'bold'),
           # legend.position = 'None',
           legend.background = element_blank(),
           legend.title = element_blank(),
           legend.text = element_text(size = 10),
           legend.position = 'bottom')

pca.plot
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '2',
            paste0(plotID, '_Plant metabarcoding ordination (Aitchison).pdf')),
       height = 5, width = 5)
```

```{r}
samdf <- data.frame(ps.mb.plant.clr@sam_data)
vegan::adonis(distance(ps.mb.plant.clr, method = 'euclidean') ~ subj, 
              data = samdf)
```

#### PCoA on distances

```{r}
# Convert to relative abundances
ps.mb.plant <- 
     transform_sample_counts(ps.mb.plant,
                             function(x){x/sum(x)})
```


```{r}
ord.mb <- 
     ordinate(ps.mb.plant.clr,
              method = 'PCoA',
              # distance = 'jaccard',
              # binary = TRUE)
              distance = 'bray')
```

```{r}
p <-  
     plot_ordination(ps.mb,
                     ord.mb,
                     type = 'samples',
                     color = 'subj')
p
```

```{r}
subj.colors <- 
     palette.colors(n = 5,
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Customize plot 
data <- data.frame(ord.mb$vectors)
samdf.mb <- data.frame(ps.mb.plant@sam_data)

data <- bind_cols(data, samdf.mb)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (26.1%)', 
          y = 'PCo2 (15.3%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme_bw() +
     theme(legend.title = element_blank()) +
     theme(axis.text = element_text(size = 12,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.title = element_text(size = 14,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.ticks = element_line(size = 1, 
                                     color = 'gray80'),
           legend.text = element_text(size = 10,
                                      face = 'bold',
                                      color = 'gray40'),
           panel.border = element_rect(size = 3,
                                       color = 'gray80'),
           panel.grid.major = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Metabarcoding ordination (Bray-Curtis).pdf')))
```

```{r}
samdf.mb.plant <- data.frame(ps.mb.plant@sam_data)

vegan::adonis(distance(ps.mb.plant, method = 'bray') ~ subj,
              data = samdf.mb.plant)
```

### Menu

### Mantel test on differences

```{r}
# Need to do only on shared samples
# Think this is okay to subset, because should be subcompositionally coherent?

samples <- intersect(sample_names(ps.protein.plant.clr),
                     sample_names(ps.mb.plant.clr))

ps.protein.plant.clr <- 
     prune_samples(samples, ps.protein.plant.clr)

ps.mb.plant.clr <- 
     prune_samples(samples, ps.mb.plant.clr)
```

```{r}
d.protein <- distance(ps.protein.plant.clr,
                      method = 'euclidean')

d.dna <- distance(ps.mb.plant.clr,
                  method = 'euclidean')
```

```{r}
vegan::mantel(d.protein, d.dna)
```

