---
title: "Ordinations"
output: html_notebook
---

# R setup

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = file.path(getwd(), '..'))
```

```{r libraries, echo=FALSE}
library(here) 
library(phyloseq) 
library(tidyverse) 
```

# Read in data

## Metaproteomic phyloseq

```{r}
ps.protein <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'ps_mp.rds') %>% # 1UP
     readRDS() 

ps.protein
```

## Menu data phyloseq

```{r}
ps.menu <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'ps_menu.rds') %>% 
     readRDS()

ps.menu
```

## Metabarcoding phyloseq

```{r}
# 12SV5
ps.mb.animal <- 
     here('data', 
          'processed', 
          'phyloseq',
          'combined',
          'ps_mb_12SV5.rds') %>% 
     readRDS()
     
ps.mb.animal
```

```{r}
# trnL
ps.mb.plant <- 
     here('data',
          'processed',
          'phyloseq',
          'combined',
          'ps_mb_trnL.rds') %>% 
     readRDS() 

ps.mb.plant
```

# Pre-process

## Metaproteomic phyloseq

```{r}
# Impose >= 5 PSM/taxon filter
asvtab.protein <- otu_table(ps.protein)@.Data
sum(asvtab.protein)

asvtab.protein[asvtab.protein < 5] <- 0
sum(asvtab.protein)

# Replace in phyloseq object
otu_table(ps.protein) <- otu_table(asvtab.protein,
                                   taxa_are_rows = FALSE)
```

### Add lag day

```{r echo = FALSE}
# Pull sample data for stool samples
samdf.protein <- 
     sample_data(ps.protein) %>% 
     as('data.frame') %>% 
     rownames_to_column(var = 'row')

# Label each stool sample with its two preceding days
for (delta in 1:2){
     varname <- paste0('delta', delta)
     samdf.protein <- mutate(samdf.protein, 
                             !!varname := paste(subj, date - delta, 
                                                sep = '_'))
}

# Replace in phyloseq object
sample_data(ps.protein) <- column_to_rownames(samdf.protein, var = 'row')
```

### Separate by kingdom

Need to think about how to transform data when doing a combined ordination on plant and animals (if this is even possible)???

For now I'm not certain, so splitting.
```{r}
nsamples(ps.protein)
```

```{r}
ps.protein.plant <- 
     ps.protein %>% 
     subset_taxa(kingdom == 'Viridiplantae') %>% 
     prune_samples(sample_sums(.) > 0, .)

ps.protein.plant
```

```{r}
ps.protein.animal <- 
     ps.protein %>% 
     subset_taxa(kingdom == 'Metazoa') %>% 
     prune_samples(sample_sums(.) > 0, .)
ps.protein.animal
```

```{r}
# What foods are left over?
ps.protein.other <- 
     ps.protein %>% 
     subset_taxa(!(kingdom %in% c('Viridiplantae',
                                  'Metazoa'))) 

ntaxa(ps.protein.other)
```

```{r}
ps.protein.other@tax_table@.Data %>% 
     data.frame()
```

A few fungi, seaweeds (Rhodophyta), spirulina.  Might be fun to do an independent analysis of the prevalence of these taxa. 

## Metabarcoding phyloseq

```{r}
# Impose >= 5 count/taxon filter
asvtab.mb <- otu_table(ps.mb)@.Data
sum(asvtab.mb)

asvtab.mb[asvtab.mb < 5] <- 0
sum(asvtab.mb)

# Replace in phyloseq object
otu_table(ps.mb) <- otu_table(asvtab.mb,
                                   taxa_are_rows = FALSE)
```

### Add lag day

```{r echo = FALSE}
# Pull sample data for stool samples
samdf.mb <- 
     sample_data(ps.mb) %>% 
     as('data.frame') %>% 
     rownames_to_column(var = 'row')

# Label each stool sample with its two preceding days
for (delta in 1:2){
     varname <- paste0('delta', delta)
     samdf.mb <- mutate(samdf.mb, 
                             !!varname := paste(subj, date - delta, 
                                                sep = '_'))
}

# Replace in phyloseq object
sample_data(ps.mb) <- column_to_rownames(samdf.mb, var = 'row')
```

### Separate by kingdom

```{r}
nsamples(ps.mb)
```

```{r}
ps.mb.plant <- 
     ps.mb %>% 
     subset_taxa(kingdom == 'Viridiplantae') %>% 
     prune_samples(sample_sums(.) > 0, .)
ps.mb.plant
```

```{r}
ps.mb.animal <- 
     ps.mb %>% 
     subset_taxa(kingdom == 'Metazoa') %>% 
     prune_samples(sample_sums(.) > 0, .)
ps.mb.animal
```

## Menu phyloseq

Here, what should I plot? Aggregated menu from 1-2 d before intake (to be consistent w/downstream results?)

Why don't I just start with one day before and see how it goes.

### Subset to lag = -1

```{r}
nsamples(ps.menu)
```

```{r}
ps.menu <- 
     ps.menu %>% 
     prune_samples(sample_names(.) %in% c(sample_data(ps.mb)$delta1,
                                         sample_data(ps.protein)$delta1),
                   .) %>% 
     prune_taxa(taxa_sums(.) > 0, .)

ps.menu
```

### Separate by kingdom

```{r}
ps.menu.plant <- 
     ps.menu %>% 
     subset_taxa(kingdom == 'Viridiplantae') %>% 
     prune_samples(sample_sums(.) > 0, .)

ps.menu.plant
```

```{r}
ps.menu.animal <- 
     ps.menu %>% 
     subset_taxa(kingdom == 'Metazoa') %>% 
     prune_samples(sample_sums(.) > 0, .)

ps.menu.animal
```

# Analyze

## Ordinations

### Metaproteomics

Is metaproteomic data compositional??
Think that it may be, because PCA on raw data looks wonky.

#### PCA

```{r}
# CLR transform
asvtab.protein <- ps.protein@otu_table@.Data 

# asvtab[asvtab < 20] = 0
asvtab.protein.clr <- driver::clr(asvtab.protein + 1) # pseudocount = 1

# Replace names, but remember these aren't interpretable as strict ASVs any longer
colnames(asvtab.protein.clr) <- colnames(asvtab.protein)

# Make updated phyloseq object
ps.protein.clr <- phyloseq(otu_table(asvtab.protein.clr, taxa_are_rows = FALSE),
                   sample_data(sample_data(ps.protein)),
                   tax_table(tax_table(ps.protein)))
```

```{r}
# Plant only
# CLR transform
asvtab.protein.plant <- 
     ps.protein %>% 
     subset_taxa(kingdom == 'Viridiplantae') %>% 
     otu_table(.) 

# asvtab[asvtab < 20] = 0
asvtab.protein.plant.clr <- 
     driver::clr(asvtab.protein.plant@.Data + 1) # pseudocount = 1

# Replace names, but remember these aren't interpretable as strict ASVs any longer
colnames(asvtab.protein.plant.clr) <- colnames(asvtab.protein.plant)

# Make updated phyloseq object
ps.protein.plant.clr <- 
     phyloseq(otu_table(asvtab.protein.plant.clr, taxa_are_rows = FALSE),
                   sample_data(sample_data(ps.protein)),
                   tax_table(tax_table(ps.protein)))
```

```{r}
# PCA
pca <- prcomp(asvtab.protein.clr, center = TRUE, scale = FALSE)
# pca <- prcomp(asvtab.protein.plant.clr, center = TRUE, scale = FALSE)

pca.df <- 
        data.frame(pca$x) %>% 
        rownames_to_column(var = 'well')

# % variance explained
eigs <- pca$sdev^2
ve.pc1 <- as.character(100*round(eigs[1] / sum(eigs), 3))
ve.pc2 <- as.character(100*round(eigs[2] / sum(eigs), 3))

# Add back sample data
samdf <- 
     data.frame(ps.protein@sam_data) %>% 
     rownames_to_column(var = 'well')

pca.df <- left_join(pca.df, samdf)

limit <- max(abs(pca.df[, c('PC1', 'PC2')])) +
          0.05*(max(abs(pca.df[, c('PC1', 'PC2')])))
```

```{r}
# Define color palettes
subj.colors <- 
     palette.colors(n = 5, 
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Plot
pca.plot <- 
     ggplot(pca.df, aes(x = PC1, y = PC2, 
                        color = subj)) +
     geom_point(size = 3, alpha = 0.7) +
     coord_equal() +
     labs(x = paste0(' PC1 (', ve.pc1, '%)'),
          y = paste0(' PC2 (', ve.pc2, '%)')) +
     scale_color_manual(values = subj.colors) +
     xlim(-limit, limit) + ylim(-limit, limit) +
     theme_classic() +
     theme(axis.line = element_line(size = 1, color = 'gray'),
           axis.ticks = element_line(color = 'gray'),
           axis.title = element_text(size = 14, face = 'bold', color = 'gray'),
           axis.text = element_blank(),
           # plot.title = element_text(size = 14, face = 'bold'),
           # legend.position = 'None',
           legend.background = element_blank(),
           legend.title = element_blank(),
           legend.text = element_text(size = 10),
           legend.position = 'bottom')

pca.plot
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '2',
            paste0(plotID, '_Plant metaproteomic ordination (Aitchison).pdf')),
       height = 5, width = 5)
```

```{r}
samdf <- data.frame(ps.protein.clr@sam_data)
vegan::adonis(distance(ps.protein.clr, method = 'euclidean') ~ subj, 
              data = samdf)
```

#### PCoA on Jaccard

```{r}
ord.protein <- 
     ordinate(ps.protein,
              method = 'PCoA',
              distance = 'jaccard',
              binary = TRUE)
```

```{r}
p <-  
     plot_ordination(ps.protein,
                     ord.protein,
                     type = 'samples',
                     color = 'subj')
p
```

```{r}
subj.colors <- 
     palette.colors(n = 5,
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Customize plot 
data <- data.frame(ord.protein$vectors)
samdf.protein <- data.frame(ps.protein@sam_data)

data <- bind_cols(data, samdf.protein)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (17.0%)',
          y = 'PCo2 (12.4%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme_bw() +
     theme(legend.title = element_blank()) +
     theme(axis.text = element_text(size = 12,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.title = element_text(size = 14,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.ticks = element_line(size = 1, 
                                     color = 'gray80'),
           legend.text = element_text(size = 10,
                                      face = 'bold',
                                      color = 'gray40'),
           panel.border = element_rect(size = 3,
                                       color = 'gray80'),
           panel.grid.major = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Metaproteomic ordination (Bray-Curtis).pdf')))
```

```{r}
vegan::adonis(distance(ps.protein, 
                       method = 'jaccard',
                       binary = TRUE) ~ subj,
              data = samdf.protein)
```

### Metabarcoding

#### PCA

```{r}
# CLR transform
asvtab.mb.plant <- ps.mb.plant@otu_table@.Data 

# asvtab[asvtab < 20] = 0
asvtab.mb.plant.clr <- driver::clr(asvtab.mb.plant + 1) # pseudocount = 1

# Replace names, but remember these aren't interpretable as strict ASVs any longer
colnames(asvtab.mb.plant.clr) <- colnames(asvtab.mb.plant)

# Make updated phyloseq object
ps.mb.plant.clr <- phyloseq(otu_table(asvtab.mb.plant.clr, 
                                      taxa_are_rows = FALSE),
                   sample_data(sample_data(ps.mb.plant)),
                   tax_table(tax_table(ps.mb.plant)))
```


```{r}
# PCA
pca <- prcomp(asvtab.mb.plant.clr, center = TRUE, scale = FALSE)

pca.df <- 
        data.frame(pca$x) %>% 
        rownames_to_column(var = 'name')

# % variance explained
eigs <- pca$sdev^2
ve.pc1 <- as.character(100*round(eigs[1] / sum(eigs), 3))
ve.pc2 <- as.character(100*round(eigs[2] / sum(eigs), 3))

# Add back sample data
samdf <- 
     data.frame(ps.mb.plant@sam_data) %>% 
     rownames_to_column(var = 'name')

pca.df <- left_join(pca.df, samdf)

limit <- max(abs(pca.df[, c('PC1', 'PC2')])) +
          0.05*(max(abs(pca.df[, c('PC1', 'PC2')])))
```

```{r}
# Define color palettes
subj.colors <- 
     palette.colors(n = 5, 
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Plot
pca.plot <- 
     ggplot(pca.df, aes(x = PC1, y = PC2, 
                        color = subj)) +
     geom_point(size = 3, alpha = 0.7) +
     coord_equal() +
     labs(x = paste0(' PC1 (', ve.pc1, '%)'),
          y = paste0(' PC2 (', ve.pc2, '%)')) +
     scale_color_manual(values = subj.colors) +
     xlim(-limit, limit) + ylim(-limit, limit) +
     theme_classic() +
     theme(axis.line = element_line(size = 1, color = 'gray'),
           axis.ticks = element_line(color = 'gray'),
           axis.title = element_text(size = 14, face = 'bold', color = 'gray'),
           axis.text = element_blank(),
           # plot.title = element_text(size = 14, face = 'bold'),
           # legend.position = 'None',
           legend.background = element_blank(),
           legend.title = element_blank(),
           legend.text = element_text(size = 10),
           legend.position = 'bottom')

pca.plot
```
```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results', 
            'manuscript',
            '2',
            paste0(plotID, '_Plant metabarcoding ordination (Aitchison).pdf')),
       height = 5, width = 5)
```

```{r}
samdf <- data.frame(ps.mb.plant.clr@sam_data)
vegan::adonis(distance(ps.mb.plant.clr, method = 'euclidean') ~ subj, 
              data = samdf)
```

#### PCoA on distances

```{r}
# Convert to relative abundances
ps.mb.plant <- 
     transform_sample_counts(ps.mb.plant,
                             function(x){x/sum(x)})
```


```{r}
ord.mb <- 
     ordinate(ps.mb.plant.clr,
              method = 'PCoA',
              # distance = 'jaccard',
              # binary = TRUE)
              distance = 'bray')
```

```{r}
p <-  
     plot_ordination(ps.mb,
                     ord.mb,
                     type = 'samples',
                     color = 'subj')
p
```

```{r}
subj.colors <- 
     palette.colors(n = 5,
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Customize plot 
data <- data.frame(ord.mb$vectors)
samdf.mb <- data.frame(ps.mb.plant@sam_data)

data <- bind_cols(data, samdf.mb)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (26.1%)', 
          y = 'PCo2 (15.3%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme_bw() +
     theme(legend.title = element_blank()) +
     theme(axis.text = element_text(size = 12,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.title = element_text(size = 14,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.ticks = element_line(size = 1, 
                                     color = 'gray80'),
           legend.text = element_text(size = 10,
                                      face = 'bold',
                                      color = 'gray40'),
           panel.border = element_rect(size = 3,
                                       color = 'gray80'),
           panel.grid.major = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Metabarcoding ordination (Bray-Curtis).pdf')))
```

```{r}
samdf.mb.plant <- data.frame(ps.mb.plant@sam_data)

vegan::adonis(distance(ps.mb.plant, method = 'bray') ~ subj,
              data = samdf.mb.plant)
```

### Menu

The menus are currently in different formats:
- DFC is absolute amount of food consumed (gram weight)
- Healthy donor is instances of food intake on a given day.

Because these can't be directly compared, I think best to just binarize for now (do this as PCoA on Jaccard).

A workaround strategy would be to label foods as "high", "med", "low" intake.  This could be done by estimation for Healthy Donor and programmatically for DFC.

#### Jaccard

```{r}
ord.menu <- 
     ordinate(ps.menu.plant,
              method = 'PCoA',
              distance = 'jaccard',
              binary = TRUE)
```

```{r}
p <-  
     plot_ordination(ps.menu.plant,
                     ord.menu,
                     type = 'samples',
                     color = 'subj')
p
```

```{r}
subj.colors <- 
     palette.colors(n = 5,
                    palette = 'Okabe-Ito') %>% 
     unname()
```

```{r}
# Customize plot 
data <- data.frame(ord.menu$vectors)
samdf.menu <- data.frame(ps.menu.plant@sam_data)

data <- bind_cols(data, samdf.menu)

ggplot(data, aes(x = Axis.1, y = Axis.2, color = subj)) +
     geom_point(alpha = 0.8,
                size = 3) +
     labs(x = 'PCo1 (17.3%)',
          y = 'PCo2 (12.5%)') +
     scale_color_manual(values = subj.colors) +
     coord_equal() +
     theme_bw() +
     theme(legend.title = element_blank()) +
     theme(axis.line = element_line(size = 1,
                                    color = 'gray80'),
           axis.text = element_text(size = 12,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.title = element_text(size = 14,
                                    face = 'bold',
                                    color = 'gray80'), 
           axis.ticks = element_line(size = 1, 
                                     color = 'gray80'),
           legend.text = element_text(size = 10,
                                      face = 'bold',
                                      color = 'gray40'),
           panel.border = element_blank(),
           panel.grid.major = element_blank())
```

```{r}
plotID <- paste(Sys.Date(), as.character(sample(000:999,1)), sep=".")

ggsave(here('results',
            'manuscript',
            '2',
            paste0(plotID, '_Menu ordination (Jaccard).pdf')))
```

```{r}
vegan::adonis(distance(ps.menu.plant, 
                       method = 'jaccard',
                       binary = TRUE) ~ subj,
              data = samdf.menu)
```

### Mantel test on differences

```{r}
# Need to do only on shared samples
# Think this is okay to subset, because should be subcompositionally coherent?

samples <- intersect(sample_names(ps.protein.plant.clr),
                     sample_names(ps.mb.plant.clr))

ps.protein.plant.clr <- 
     prune_samples(samples, ps.protein.plant.clr)

ps.mb.plant.clr <- 
     prune_samples(samples, ps.mb.plant.clr)
```

```{r}
d.protein <- distance(ps.protein.plant.clr,
                      method = 'euclidean')

d.dna <- distance(ps.mb.plant.clr,
                  method = 'euclidean')
```

```{r}
vegan::mantel(d.protein, d.dna)
```

